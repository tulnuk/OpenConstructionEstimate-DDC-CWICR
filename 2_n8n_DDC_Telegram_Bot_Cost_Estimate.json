{
  "name": "DDC CWICR Telegram Bot v9.2",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "b8294034-5d73-4baa-a991-c3fce367fdba",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        496
      ],
      "webhookId": "bot-v83-pro",
      "credentials": {
        "telegramApi": {
          "id": "l5t1NiN0XgmAuJlO",
          "name": "OCE"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"bot_token\": \"7990641026:AAHq09TaJG8EGBfqPalNWOFz2QNmawWZ8tE\",\n  \"AI_PROVIDER\": \"gemini\",\n  \"GEMINI_API_KEY\": \"AIzaSyD_bzlSFXMmDn3O1uaU2gxb-OMEatqYXE0\",\n  \"OPENAI_API_KEY\": \"YOUR_OPENAI_API_KEY_HERE\"\n}",
        "options": {}
      },
      "id": "7c4d5ddb-190e-48f3-8018-7455e9541886",
      "name": "ğŸ”‘ TOKEN",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        432,
        496
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAIN ROUTER v8.3 PRO - Multi-photo, Voice, Edit, Categories, Export\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst update = $('Telegram Trigger').first().json;\nconst botToken = $input.first().json.bot_token;\nconst isCallback = !!update.callback_query;\n\nlet chatId, callbackData, callbackQueryId, text, fileId, hasImage, caption, hasVoice, voiceFileId, mediaGroupId;\n\nif (isCallback) {\n  const cb = update.callback_query;\n  chatId = cb.message?.chat?.id;\n  callbackData = cb.data || '';\n  callbackQueryId = cb.id;\n  text = ''; fileId = null; hasImage = false; caption = ''; hasVoice = false; voiceFileId = null; mediaGroupId = null;\n} else {\n  const msg = update.message || {};\n  chatId = msg.chat?.id;\n  callbackData = ''; callbackQueryId = '';\n  text = msg.text || ''; caption = msg.caption || '';\n  mediaGroupId = msg.media_group_id || null;\n  \n  // Photo detection\n  const photo = msg.photo || [];\n  fileId = photo.length > 0 ? photo[photo.length - 1].file_id : null;\n  hasImage = !!fileId;\n  if (!fileId && msg.document?.mime_type?.startsWith('image/')) {\n    fileId = msg.document.file_id; hasImage = true;\n  }\n  \n  // Voice detection\n  hasVoice = !!(msg.voice || msg.audio);\n  voiceFileId = msg.voice?.file_id || msg.audio?.file_id || null;\n}\n\nconst sd = $getWorkflowStaticData('global');\nif (!sd.sess) sd.sess = {};\nconst cid = String(chatId);\nif (!sd.sess[cid]) sd.sess[cid] = { \n  lang: null, works: [], state: 'new', db: null, L: null, \n  photos: [], voiceText: '', description: '',\n  categories: { demolition: true, rough: true, finishing: true, mep: true }\n};\nconst S = sd.sess[cid];\n\nlet action = 'none';\n\n// === COMMANDS ===\nif (text.toLowerCase() === '/start') {\n  S.lang = null; S.works = []; S.state = 'wait_lang'; S.db = null; S.L = null;\n  S.photos = []; S.voiceText = ''; S.description = '';\n  action = 'show_lang';\n}\nelse if (text.toLowerCase() === '/help') {\n  action = 'show_help';\n}\n\n// === LANGUAGE SELECTION ===\nelse if (/^lang_(DE|EN|RU|ES|FR|PT|ZH|AR|HI)$/i.test(callbackData)) {\n  S.lang = callbackData.replace('lang_', '').toUpperCase();\n  S.state = 'wait_photo'; action = 'lang_selected';\n}\n\n// === PHOTO HANDLING (Multi-photo support) ===\nelse if (hasImage && S.lang) {\n  // Add photo to collection\n  S.photos.push({ fileId, caption });\n  if (caption) S.description = caption;\n  \n  // If part of media group, wait for more photos\n  if (mediaGroupId) {\n    S.mediaGroupId = mediaGroupId;\n    S.state = 'collecting_photos';\n    action = 'photo_added';\n  } else {\n    // Single photo - go to analyze\n    S.state = 'ready_to_analyze';\n    action = 'show_analyze_options';\n  }\n}\n\n// === VOICE MESSAGE ===\nelse if (hasVoice && S.lang) {\n  S.voiceFileId = voiceFileId;\n  S.state = 'processing_voice';\n  action = 'process_voice';\n  session.voiceFileId = voiceFileId;\n}\n\n// === ANALYZE BUTTON ===\nelse if (callbackData === 'analyze_photos') {\n  if (S.photos.length > 0) {\n    S.state = 'analyzing';\n    action = 'analyze';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === ADD MORE PHOTOS ===\nelse if (callbackData === 'add_more_photos') {\n  S.state = 'wait_photo';\n  action = 'ask_more_photos';\n}\n\n// === CATEGORY FILTERS ===\nelse if (/^cat_(demolition|rough|finishing|mep)$/.test(callbackData)) {\n  const cat = callbackData.replace('cat_', '');\n  S.categories[cat] = !S.categories[cat];\n  action = 'update_categories';\n}\n\n// === EDIT WORK ITEMS ===\nelse if (/^edit_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/edit_work_(\\d+)/)[1]);\n  S.editingWorkIndex = idx;\n  S.state = 'editing_work';\n  action = 'show_edit_menu';\n}\nelse if (/^delete_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/delete_work_(\\d+)/)[1]);\n  if (S.works[idx]) {\n    S.works.splice(idx, 1);\n    // Re-index\n    S.works.forEach((w, i) => { w.seq = i + 1; w.id = `W${String(i+1).padStart(3,'0')}`; });\n  }\n  action = 'works_updated';\n}\nelse if (/^qty_work_(\\d+)_(.+)$/.test(callbackData)) {\n  const match = callbackData.match(/qty_work_(\\d+)_(.+)/);\n  const idx = parseInt(match[1]);\n  const change = match[2]; // plus10, minus10, plus1, minus1, double, half\n  if (S.works[idx]) {\n    let q = S.works[idx].qty;\n    if (change === 'plus10') q += 10;\n    else if (change === 'minus10') q = Math.max(1, q - 10);\n    else if (change === 'plus1') q += 1;\n    else if (change === 'minus1') q = Math.max(1, q - 1);\n    else if (change === 'double') q *= 2;\n    else if (change === 'half') q = Math.max(1, Math.round(q / 2));\n    S.works[idx].qty = q;\n  }\n  action = 'works_updated';\n}\nelse if (callbackData === 'add_work') {\n  S.state = 'adding_work';\n  action = 'ask_new_work';\n}\nelse if (callbackData === 'done_editing') {\n  S.state = 'works_shown';\n  action = 'show_works_final';\n}\n\n// === CALCULATE ===\nelse if (callbackData === 'refine_analysis') {\n  action = 'refine_analysis';\n}\nelse if (callbackData === 'calculate') {\n  if (S.works && S.works.length > 0) {\n    S.state = 'calc';\n    action = 'start_calc';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === EXPORT OPTIONS ===\nelse if (callbackData === 'view_details') {\n  action = 'view_details';\n}\nelse if (callbackData === 'export_excel') {\n  action = 'export_excel';\n}\nelse if (callbackData === 'export_pdf') {\n  action = 'export_pdf';\n}\n\n// === NEW ESTIMATE / RESTART ===\nelse if (callbackData === 'new_photo' || callbackData === 'new_estimate' || callbackData === 'restart') {\n  S.photos = []; S.works = []; S.voiceText = ''; S.description = '';\n  S.state = 'wait_photo';\n  action = 'ask_photo';\n}\nelse if (callbackData === 'show_help' || callbackData === 'help') {\n  action = 'show_help';\n}\nelse if (callbackData === 'change_language') {\n  S.lang = null; S.state = 'wait_lang';\n  action = 'show_lang';\n}\n\n// === TEXT INPUT (for adding work or voice transcription result) ===\nelse if (text && S.state === 'adding_work') {\n  // Parse: \"ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹, 10 Ğ¼Â²\"\n  const parts = text.split(',');\n  const name = parts[0]?.trim() || text;\n  let qty = 1, unit = 'mÂ²';\n  if (parts[1]) {\n    const qtyMatch = parts[1].match(/([\\d.,]+)\\s*(.*)/);\n    if (qtyMatch) {\n      qty = parseFloat(qtyMatch[1].replace(',', '.')) || 1;\n      unit = qtyMatch[2]?.trim() || 'mÂ²';\n    }\n  }\n  const newWork = {\n    id: `W${String(S.works.length + 1).padStart(3,'0')}`,\n    name, query: name, qty, unit, conf: 'medium', category: 'general', seq: S.works.length + 1\n  };\n  S.works.push(newWork);\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === FALLBACKS ===\nelse if (!S.lang) { action = 'show_lang'; }\nelse if (S.state === 'wait_photo' && !hasImage && text && text.length > 5) {\n  // User sent text description - treat as work list\n  S.description = text;\n  S.textInput = text;\n  S.photos = S.photos || [];\n  action = 'analyze_text';\n}\nelse if (S.state === 'wait_photo' && !hasImage) { action = 'ask_photo'; }\nelse if (S.state === 'collecting_photos') {\n  // Check if media group collection is done (timeout handled separately)\n  action = 'none';\n}\n\nreturn { json: { \n  bot_token: botToken, chatId, action, lang: S.lang, works: S.works, \n  callbackData, callbackQueryId, isCallback, hasImage, hasVoice, \n  fileId, voiceFileId, text, caption, photos: S.photos,\n  categories: S.categories, editingWorkIndex: S.editingWorkIndex,\n  description: S.description, voiceText: S.voiceText\n}};"
      },
      "id": "3f6e2aed-ff56-4caf-a015-245895db6640",
      "name": "Main",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        496
      ]
    },
    {
      "parameters": {
        "jsCode": "// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n\n// CONFIG v8.4 PRO - Professional style localization\n\nconst input = $input.first().json;\nconst lang = (input.lang || 'EN').toUpperCase();\nconst chatId = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nconst LANGS = {\n  'DE': { \n    db: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'German', flag: 'ğŸ‡©ğŸ‡ª', native: 'Deutsch', cur: 'EUR', sym: 'â‚¬', loc: 'de-DE', region: 'Berlin', search_lang: 'German',\n    // Professional welcome\n    ok: 'âœ… *Deutsch* Â· Berlin Â· EUR',\n    photo: '*Foto oder Beschreibung senden*\\n\\nBeispiel zum Kopieren:\\n```\\nGipskarton 2-lagig Metallprofil CW75 25m2\\nFliesen Feinsteinzeug 60x60 Bad 15m2\\nSpachteln Q3 Decken und Waende 120m2\\nElektro Steckdosen UP 20 Stueck\\nMalerarbeiten Dispersionsfarbe 80m2\\n```\\n\\nOder Foto senden ğŸ“·',\n    photo_added: 'âœ… Foto hinzugefÃ¼gt',\n    photos_count: 'Fotos',\n    add_more: '+ Weitere Fotos',\n    analyze_now: 'â–¶ Analyse starten',\n    analyzing: 'Bildanalyse lÃ¤uft...',\n    found: '*Erkannte Leistungen:*',\n    edit_hint: 'Zur Bearbeitung antippen',\n    calc: 'Preisermittlung',\n    ready: '*KOSTENVORANSCHLAG*',\n    total: 'GESAMT',\n    days: 'Tage',\n    pct: 'Trefferquote',\n    workers: 'Lohn',\n    machines: 'GerÃ¤te',\n    materials: 'Material',\n    subtotal: 'Zusammenfassung',\n    searching: 'Suche',\n    of: 'von',\n    not_found: 'Keine Ãœbereinstimmung',\n    low_conf: 'PrÃ¼fung empfohlen',\n    price_note: 'Preisbasis: Berlin 2025',\n    btn_calc: 'â–¶ Berechnen',\n    btn_new: '+ Neues Projekt',\n    btn_lang: 'âš™ Sprache',\n    btn_edit: 'âœ Ã„ndern',\n    btn_delete: 'âœ• Entfernen',\n    btn_add_work: '+ Position',\n    btn_done: 'âœ… Fertig',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Neu starten',\n    btn_help: '? Hilfe',\n    loading: 'Preisermittlung lÃ¤uft...',\n    more_in_html: 'Detaillierter Bericht verfÃ¼gbar',\n    resources: 'Ressourcen',\n    enter_work: '*Neue Position hinzufÃ¼gen*\\nFormat: Bezeichnung, Menge Einheit\\nBeispiel: Gipskartonwand, 15 mÂ²',\n    work_added: 'âœ… Position hinzugefÃ¼gt',\n    what_next: '*Weitere Optionen:*',\n    categories: 'Kategorien',\n    cat_demolition: 'Abbruch',\n    cat_rough: 'Rohbau',\n    cat_finishing: 'Ausbau',\n    cat_mep: 'TGA',\n    help_title: '*Benutzerhandbuch*',\n    help_text: '*Benutzerhandbuch*\\n\\n*1. Dokumentation*\\nSenden Sie bis zu 4 Fotos der Baustelle. Sprachnachrichten werden automatisch transkribiert.\\n\\n*2. PrÃ¼fung*\\nÃœberprÃ¼fen Sie die erkannten Leistungen. Mengen kÃ¶nnen angepasst werden.\\n\\n*3. Kalkulation*\\nDie Preisermittlung erfolgt auf Basis der DDC CWICR Datenbank.\\n\\n*4. Export*\\nErgebnisse als Excel oder PDF exportieren.\\n\\n*Befehle:*\\n/start â€” Neues Projekt\\n/help â€” Diese Hilfe',\n    doc_title: 'KOSTENVORANSCHLAG',\n    col_pos: 'Pos', col_code: 'Kennziffer', col_desc: 'Bezeichnung', col_unit: 'Einh.', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std', col_quality: 'Q',\n    grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage',\n    kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage',\n    chart_cost_structure: 'Kostenstruktur', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'GerÃ¤te',\n    res_labor: 'Lohn', res_material: 'Mat', res_machine: 'Ger',\n    collapse_all: 'Alle einklappen', expand_all: 'Alle ausklappen',\n    quality_high: 'Hohe Ãœbereinstimmung', quality_medium: 'Mittlere Ãœbereinstimmung', quality_low: 'Geringe Ãœbereinstimmung',\n    export_excel_msg: 'Excel-Export (CSV)', export_pdf_msg: 'PDF-Export (HTML - im Browser Ã¶ffnen und als PDF drucken)', btn_refine: 'Genauer analysieren', found_pct: 'gefunden', more_resources: 'weitere', kpi_items: 'Positionen'\n  },\n  'EN': { \n    db: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'English', flag: 'ğŸ‡¬ğŸ‡§', native: 'English', cur: 'CAD', sym: '$', loc: 'en-CA', region: 'Toronto', search_lang: 'English',\n    ok: 'âœ… *English* Â· Toronto Â· CAD',\n    photo: '*Send photo or description*\\n\\nExample to copy:\\n```\\nDrywall 2-layer metal stud CW75 25m2\\nPorcelain tiles 60x60 bathroom 15m2\\nPlastering level 3 ceiling walls 120m2\\nElectrical outlets flush mount 20 pcs\\nPainting emulsion 2 coats 80m2\\n```\\n\\nOr send a photo ğŸ“·',\n    photo_added: 'âœ… Photo added',\n    photos_count: 'photos',\n    add_more: '+ Add more',\n    analyze_now: 'â–¶ Start analysis',\n    analyzing: 'Analyzing images...',\n    found: '*Identified Work Items:*',\n    edit_hint: 'Tap to edit',\n    calc: 'Pricing lookup',\n    ready: '*COST ESTIMATE*',\n    total: 'TOTAL',\n    days: 'days',\n    pct: 'Match rate',\n    workers: 'Labor',\n    machines: 'Equipment',\n    materials: 'Materials',\n    subtotal: 'Summary',\n    searching: 'Searching',\n    of: 'of',\n    not_found: 'No match found',\n    low_conf: 'Review recommended',\n    price_note: 'Price basis: Toronto 2025',\n    btn_calc: 'â–¶ Calculate',\n    btn_new: '+ New Project',\n    btn_lang: 'âš™ Language',\n    btn_edit: 'âœ Edit',\n    btn_delete: 'âœ• Remove',\n    btn_add_work: '+ Add Item',\n    btn_done: 'âœ… Done',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Start Over',\n    btn_help: '? Help',\n    loading: 'Calculating prices...',\n    more_in_html: 'Detailed report available',\n    resources: 'Resources',\n    enter_work: '*Add New Item*\\nFormat: Description, Quantity Unit\\nExample: Drywall installation, 15 mÂ²',\n    work_added: 'âœ… Item added',\n    what_next: '*Options:*',\n    categories: 'Categories',\n    cat_demolition: 'Demolition',\n    cat_rough: 'Structure',\n    cat_finishing: 'Finishes',\n    cat_mep: 'MEP',\n    help_title: '*User Guide*',\n    help_text: '*User Guide*\\n\\n*1. Documentation*\\nSend up to 4 photos of the construction site. Voice messages are automatically transcribed.\\n\\n*2. Review*\\nCheck identified work items. Quantities can be adjusted.\\n\\n*3. Calculation*\\nPricing is based on the DDC CWICR database.\\n\\n*4. Export*\\nExport results as Excel or PDF.\\n\\n*Commands:*\\n/start â€” New project\\n/help â€” This guide',\n    doc_title: 'COST ESTIMATE',\n    col_pos: 'No', col_code: 'Code', col_desc: 'Description', col_unit: 'Unit', col_qty: 'Qty', col_price: 'Rate', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days',\n    kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days',\n    chart_cost_structure: 'Cost Structure', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Equipment',\n    res_labor: 'Labor', res_material: 'Mat', res_machine: 'Equip',\n    collapse_all: 'Collapse all', expand_all: 'Expand all',\n    quality_high: 'High confidence', quality_medium: 'Medium confidence', quality_low: 'Low confidence',\n    export_excel_msg: 'Excel Export (CSV)', export_pdf_msg: 'PDF Export (HTML - open in browser and print to PDF)', btn_refine: 'Refine Analysis'\n  },\n  'RU': { \n    db: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Russian', flag: 'ğŸ‡·ğŸ‡º', native: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', cur: 'RUB', sym: 'â‚½', loc: 'ru-RU', region: 'Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³', search_lang: 'Russian',\n    ok: 'âœ… *Ğ ÑƒÑÑĞºĞ¸Ğ¹* Â· Ğ¡ĞŸĞ± Â· RUB',\n    photo: '*ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ*\\n\\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:\\n```\\nĞ“Ğ¸Ğ¿ÑĞ¾ĞºĞ°Ñ€Ñ‚Ğ¾Ğ½ 2 ÑĞ»Ğ¾Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ĞŸĞŸ60 25Ğ¼2\\nĞŸĞ»Ğ¸Ñ‚ĞºĞ° ĞºĞµÑ€Ğ°Ğ¼Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‚ 60x60 Ğ²Ğ°Ğ½Ğ½Ğ°Ñ 15Ğ¼2\\nĞ¨Ğ¿Ğ°ĞºĞ»ĞµĞ²ĞºĞ° Ğ¿Ğ¾Ğ´ Ğ¿Ğ¾ĞºÑ€Ğ°ÑĞºÑƒ Ğ¿Ğ¾Ñ‚Ğ¾Ğ»ĞºĞ¸ ÑÑ‚ĞµĞ½Ñ‹ 120Ğ¼2\\nĞ Ğ¾Ğ·ĞµÑ‚ĞºĞ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ğ¼Ğ¾Ğ½Ñ‚Ğ°Ğ¶ 20ÑˆÑ‚\\nĞŸĞ¾ĞºÑ€Ğ°ÑĞºĞ° Ğ²Ğ¾Ğ´Ğ¾ÑĞ¼ÑƒĞ»ÑŒÑĞ¸Ğ¾Ğ½Ğ½Ğ°Ñ 2 ÑĞ»Ğ¾Ñ 80Ğ¼2\\n```\\n\\nĞ˜Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ğŸ“·',\n    photo_added: 'âœ… Ğ¤Ğ¾Ñ‚Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾',\n    photos_count: 'Ñ„Ğ¾Ñ‚Ğ¾',\n    add_more: '+ Ğ•Ñ‰Ñ‘ Ñ„Ğ¾Ñ‚Ğ¾',\n    analyze_now: 'â–¶ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·',\n    analyzing: 'ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹...',\n    found: '*ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:*',\n    edit_hint: 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ',\n    calc: 'ĞŸĞ¾Ğ¸ÑĞº Ñ€Ğ°ÑÑ†ĞµĞ½Ğ¾Ğº',\n    ready: '*Ğ¡ĞœĞ•Ğ¢Ğ*',\n    total: 'Ğ˜Ğ¢ĞĞ“Ğ',\n    days: 'Ğ´Ğ½.',\n    pct: 'Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ',\n    workers: 'Ğ¢Ñ€ÑƒĞ´',\n    machines: 'ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹',\n    materials: 'ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹',\n    subtotal: 'Ğ¡Ğ²Ğ¾Ğ´ĞºĞ°',\n    searching: 'ĞŸĞ¾Ğ¸ÑĞº',\n    of: 'Ğ¸Ğ·',\n    not_found: 'ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾',\n    low_conf: 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸',\n    price_note: 'Ğ‘Ğ°Ğ·Ğ° Ñ†ĞµĞ½: Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³ 2025',\n    btn_calc: 'â–¶ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ',\n    btn_new: '+ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚',\n    btn_lang: 'âš™ Ğ¯Ğ·Ñ‹Ğº',\n    btn_edit: 'âœ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ',\n    btn_delete: 'âœ• Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ',\n    btn_add_work: '+ ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ',\n    btn_done: 'âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾',\n    btn_help: '? Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°',\n    loading: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...',\n    more_in_html: 'ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½',\n    resources: 'Ğ ĞµÑÑƒÑ€ÑÑ‹',\n    enter_work: '*Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ*\\nĞ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ°\\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶ Ğ“ĞšĞ›, 15 Ğ¼Â²',\n    work_added: 'âœ… ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°',\n    what_next: '*Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:*',\n    categories: 'ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸',\n    cat_demolition: 'Ğ”ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°Ğ¶',\n    cat_rough: 'Ğ§ĞµÑ€Ğ½Ğ¾Ğ²Ñ‹Ğµ',\n    cat_finishing: 'ĞÑ‚Ğ´ĞµĞ»ĞºĞ°',\n    cat_mep: 'Ğ˜Ğ½Ğ¶ĞµĞ½ĞµÑ€Ğ¸Ñ',\n    help_title: '*Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾*',\n    help_text: '*Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ*\\n\\n*1. Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ*\\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ´Ğ¾ 4 Ñ„Ğ¾Ñ‚Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°. Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°ÑÑ‚ÑÑ.\\n\\n*2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°*\\nĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹. ĞĞ±ÑŠÑ‘Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ.\\n\\n*3. Ğ Ğ°ÑÑ‡Ñ‘Ñ‚*\\nĞ¦ĞµĞ½Ñ‹ Ğ±ĞµÑ€ÑƒÑ‚ÑÑ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ DDC CWICR.\\n\\n*4. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚*\\nĞ’Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ² Excel Ğ¸Ğ»Ğ¸ PDF.\\n\\n*ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:*\\n/start â€” ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚\\n/help â€” Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°',\n    doc_title: 'Ğ¡ĞœĞ•Ğ¢Ğ',\n    col_pos: 'â„–', col_code: 'Ğ¨Ğ¸Ñ„Ñ€', col_desc: 'ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ', col_unit: 'Ğ•Ğ´.', col_qty: 'ĞšĞ¾Ğ».', col_price: 'Ğ¦ĞµĞ½Ğ°', col_total: 'Ğ¡ÑƒĞ¼Ğ¼Ğ°', col_labor: 'Ğ§/Ñ‡', col_quality: 'Ğš',\n    grand_total: 'Ğ’Ğ¡Ğ•Ğ“Ğ', labor_cost: 'Ğ¤ĞĞ¢', material_cost: 'ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹', labor_days: 'Ğ”Ğ½ĞµĞ¹',\n    kpi_total: 'Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ', kpi_hours: 'Ğ¢Ñ€ÑƒĞ´Ğ¾Ğ·Ğ°Ñ‚Ñ€Ğ°Ñ‚Ñ‹', kpi_days: 'Ğ¡Ñ€Ğ¾Ğº',\n    chart_cost_structure: 'Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ·Ğ°Ñ‚Ñ€Ğ°Ñ‚', chart_labor: 'Ğ¢Ñ€ÑƒĞ´', chart_material: 'ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹', chart_machines: 'ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹',\n    res_labor: 'Ğ¢Ñ€ÑƒĞ´', res_material: 'ĞœĞ°Ñ‚', res_machine: 'ĞœĞµÑ…',\n    collapse_all: 'Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ', expand_all: 'Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ',\n    quality_high: 'Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ', quality_medium: 'Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ', quality_low: 'ĞĞ¸Ğ·ĞºĞ°Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ',\n    export_excel_msg: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Excel (CSV)', export_pdf_msg: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ PDF (HTML â€” Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ Ğ¸ Ñ€Ğ°ÑĞ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹Ñ‚Ğµ ĞºĞ°Ğº PDF)', btn_refine: 'Ğ£Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·', found_pct: 'Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾', more_resources: 'ĞµÑ‰Ñ‘', kpi_items: 'ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸'\n  },\n  'ES': { db: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'Spanish', flag: 'ğŸ‡ªğŸ‡¸', native: 'EspaÃ±ol', cur: 'EUR', sym: 'â‚¬', loc: 'es-ES', region: 'Barcelona', search_lang: 'Spanish',\n    ok: 'âœ… *EspaÃ±ol* Â· Barcelona Â· EUR', photo: '*EnvÃ­e foto o descripciÃ³n*\\n\\nEjemplo para copiar:\\n```\\nPladur 2 capas perfil 25m2\\nAzulejos porcelanico 60x60 bano 15m2\\nEnlucido techos paredes 120m2\\nEnchufes empotrados 20 uds\\nPintura plastica 2 capas 80m2\\n```\\n\\n_O envÃ­e foto_ ğŸ“·', photo_added: 'âœ… Foto aÃ±adida', photos_count: 'fotos', add_more: '+ MÃ¡s fotos', analyze_now: 'â–¶ Analizar', analyzing: 'Analizando...', found: '*Trabajos identificados:*', edit_hint: 'Toque para editar', calc: 'BÃºsqueda de precios', ready: '*PRESUPUESTO*', total: 'TOTAL', days: 'dÃ­as', pct: 'PrecisiÃ³n', workers: 'M.O.', machines: 'Equipos', materials: 'Materiales', subtotal: 'Resumen', searching: 'Buscando', of: 'de', not_found: 'Sin coincidencia', low_conf: 'Revisar', price_note: 'Base: Barcelona 2025', btn_calc: 'â–¶ Calcular', btn_new: '+ Nuevo', btn_lang: 'âš™ Idioma', btn_edit: 'âœ Editar', btn_delete: 'âœ• Eliminar', btn_add_work: '+ Partida', btn_done: 'âœ… Listo', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» Reiniciar', btn_help: '? Ayuda', loading: 'Calculando...', more_in_html: 'Informe detallado disponible', resources: 'Recursos', enter_work: '*AÃ±adir partida*\\nFormato: DescripciÃ³n, Cantidad Unidad', work_added: 'âœ… AÃ±adido', what_next: '*Opciones:*', categories: 'CategorÃ­as', cat_demolition: 'DemoliciÃ³n', cat_rough: 'Estructura', cat_finishing: 'Acabados', cat_mep: 'Instalaciones', help_title: '*GuÃ­a*', help_text: '*GuÃ­a de uso*\\n\\n*1.* EnvÃ­e hasta 4 fotos\\n*2.* Revise los trabajos\\n*3.* Calcule precios\\n*4.* Exporte resultados\\n\\n/start â€” Nuevo\\n/help â€” Ayuda',\n    doc_title: 'PRESUPUESTO', col_pos: 'NÂº', col_code: 'CÃ³digo', col_desc: 'DescripciÃ³n', col_unit: 'Ud', col_qty: 'Cant', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiales', labor_days: 'DÃ­as', kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'DÃ­as', chart_cost_structure: 'Estructura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq', res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq', collapse_all: 'Contraer', expand_all: 'Expandir', quality_high: 'Alta', quality_medium: 'Media', quality_low: 'Baja', export_excel_msg: 'Exportar Excel (CSV)', export_pdf_msg: 'Exportar PDF (HTML - abrir en navegador e imprimir como PDF)', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mÃ¡s', kpi_items: 'ArtÃ­culos' },\n  'FR': { db: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'French', flag: 'ğŸ‡«ğŸ‡·', native: 'FranÃ§ais', cur: 'EUR', sym: 'â‚¬', loc: 'fr-FR', region: 'Paris', search_lang: 'French',\n    ok: 'âœ… *FranÃ§ais* Â· Paris Â· EUR', photo: '*Envoyez photo ou description*\\n\\nExemple a copier:\\n```\\nPlaco 2 couches ossature 25m2\\nCarrelage gres 60x60 sdb 15m2\\nEnduit plafonds murs 120m2\\nPrises encastrees 20 pcs\\nPeinture acrylique 2 couches 80m2\\n```\\n\\nOu envoyez photo ğŸ“·', photo_added: 'âœ… Photo ajoutÃ©e', photos_count: 'photos', add_more: '+ Autres photos', analyze_now: 'â–¶ Analyser', analyzing: 'Analyse en cours...', found: '*Ouvrages identifiÃ©s:*', edit_hint: 'Appuyez pour modifier', calc: 'Recherche des prix', ready: '*DEVIS*', total: 'TOTAL', days: 'jours', pct: 'PrÃ©cision', workers: 'M.O.', machines: 'MatÃ©riel', materials: 'MatÃ©riaux', subtotal: 'RÃ©sumÃ©', searching: 'Recherche', of: 'sur', not_found: 'Non trouvÃ©', low_conf: 'Ã€ vÃ©rifier', price_note: 'Base: Paris 2025', btn_calc: 'â–¶ Calculer', btn_new: '+ Nouveau', btn_lang: 'âš™ Langue', btn_edit: 'âœ Modifier', btn_delete: 'âœ• Supprimer', btn_add_work: '+ Ouvrage', btn_done: 'âœ… TerminÃ©', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» Recommencer', btn_help: '? Aide', loading: 'Calcul en cours...', more_in_html: 'Rapport dÃ©taillÃ© disponible', resources: 'Ressources', enter_work: '*Ajouter ouvrage*\\nFormat: Description, QuantitÃ© UnitÃ©', work_added: 'âœ… AjoutÃ©', what_next: '*Options:*', categories: 'CatÃ©gories', cat_demolition: 'DÃ©molition', cat_rough: 'Gros Å“uvre', cat_finishing: 'Finitions', cat_mep: 'CVC', help_title: '*Guide*', help_text: '*Guide d\\'utilisation*\\n\\n*1.* Envoyez jusqu\\'Ã  4 photos\\n*2.* VÃ©rifiez les ouvrages\\n*3.* Calculez les prix\\n*4.* Exportez\\n\\n/start â€” Nouveau\\n/help â€” Aide',\n    doc_title: 'DEVIS', col_pos: 'NÂ°', col_code: 'Code', col_desc: 'DÃ©signation', col_unit: 'U', col_qty: 'QtÃ©', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'MatÃ©riaux', labor_days: 'Jours', kpi_total: 'CoÃ»t Total', kpi_hours: 'Heures', kpi_days: 'Jours', chart_cost_structure: 'Structure', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Ã‰q', res_labor: 'MO', res_material: 'Mat', res_machine: 'Ã‰q', collapse_all: 'RÃ©duire', expand_all: 'DÃ©velopper', quality_high: 'Haute', quality_medium: 'Moyenne', quality_low: 'Faible', export_excel_msg: 'Export Excel (CSV)', export_pdf_msg: 'Export PDF (HTML - ouvrir dans le navigateur et imprimer en PDF)', btn_refine: 'Affiner l\\'analyse' },\n  'PT': { db: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'Portuguese', flag: 'ğŸ‡§ğŸ‡·', native: 'PortuguÃªs', cur: 'BRL', sym: 'R$', loc: 'pt-BR', region: 'SÃ£o Paulo', search_lang: 'Portuguese',\n    ok: 'âœ… *PortuguÃªs* Â· SÃ£o Paulo Â· BRL', photo: '*Envie foto ou descricao*\\n\\nExemplo para copiar:\\n```\\nDrywall 2 camadas perfil 25m2\\nPorcelanato 60x60 banheiro 15m2\\nMassa corrida teto paredes 120m2\\nTomadas embutidas 20 und\\nPintura acrilica 2 demaos 80m2\\n```\\n\\n_Ou envie foto_ ğŸ“·', photo_added: 'âœ… Foto adicionada', photos_count: 'fotos', add_more: '+ Mais fotos', analyze_now: 'â–¶ Analisar', analyzing: 'Analisando...', found: '*ServiÃ§os identificados:*', edit_hint: 'Toque para editar', calc: 'Busca de preÃ§os', ready: '*ORÃ‡AMENTO*', total: 'TOTAL', days: 'dias', pct: 'PrecisÃ£o', workers: 'M.O.', machines: 'Equipamentos', materials: 'Materiais', subtotal: 'Resumo', searching: 'Buscando', of: 'de', not_found: 'NÃ£o encontrado', low_conf: 'Verificar', price_note: 'Base: SÃ£o Paulo 2025', btn_calc: 'â–¶ Calcular', btn_new: '+ Novo', btn_lang: 'âš™ Idioma', btn_edit: 'âœ Editar', btn_delete: 'âœ• Excluir', btn_add_work: '+ ServiÃ§o', btn_done: 'âœ… Pronto', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» RecomeÃ§ar', btn_help: '? Ajuda', loading: 'Calculando...', more_in_html: 'RelatÃ³rio detalhado disponÃ­vel', resources: 'Recursos', enter_work: '*Adicionar serviÃ§o*\\nFormato: DescriÃ§Ã£o, Quantidade Unidade', work_added: 'âœ… Adicionado', what_next: '*OpÃ§Ãµes:*', categories: 'Categorias', cat_demolition: 'DemoliÃ§Ã£o', cat_rough: 'Estrutura', cat_finishing: 'Acabamento', cat_mep: 'InstalaÃ§Ãµes', help_title: '*Guia*', help_text: '*Guia de uso*\\n\\n*1.* Envie atÃ© 4 fotos\\n*2.* Revise os serviÃ§os\\n*3.* Calcule preÃ§os\\n*4.* Exporte\\n\\n/start â€” Novo\\n/help â€” Ajuda',\n    doc_title: 'ORÃ‡AMENTO', col_pos: 'NÂº', col_code: 'CÃ³digo', col_desc: 'DescriÃ§Ã£o', col_unit: 'Un', col_qty: 'Qtd', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiais', labor_days: 'Dias', kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias', chart_cost_structure: 'Estrutura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq', res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq', collapse_all: 'Recolher', expand_all: 'Expandir', quality_high: 'Alta', quality_medium: 'MÃ©dia', quality_low: 'Baixa', export_excel_msg: 'Exportar Excel (CSV)', export_pdf_msg: 'Exportar PDF (HTML - abrir no navegador e imprimir como PDF)', btn_refine: 'Refinar anÃ¡lise' },\n  'ZH': { db: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'Chinese', flag: 'ğŸ‡¨ğŸ‡³', native: 'ä¸­æ–‡', cur: 'CNY', sym: 'Â¥', loc: 'zh-CN', region: 'ä¸Šæµ·', search_lang: 'Chinese',\n    ok: 'âœ… *ä¸­æ–‡* Â· ä¸Šæµ· Â· CNY', photo: '*å‘é€ç…§ç‰‡æˆ–æè¿°*\\n\\nå¤åˆ¶ç¤ºä¾‹:\\n```\\nçŸ³è†æ¿åŒå±‚è½»é’¢é¾™éª¨ 25m2\\nç“·ç –600x600å«ç”Ÿé—´ 15m2\\nè…»å­æ‰¾å¹³é¡¶å¢™ 120m2\\næš—è£…æ’åº§ 20ä¸ª\\nä¹³èƒ¶æ¼†ä¸¤é 80m2\\n```\\n\\næˆ–å‘é€ç…§ç‰‡ ğŸ“·', photo_added: 'âœ… ç…§ç‰‡å·²æ·»åŠ ', photos_count: 'å¼ ', add_more: '+ æ›´å¤šç…§ç‰‡', analyze_now: 'â–¶ å¼€å§‹åˆ†æ', analyzing: 'åˆ†æä¸­...', found: '*è¯†åˆ«çš„å·¥ä½œé¡¹:*', edit_hint: 'ç‚¹å‡»ç¼–è¾‘', calc: 'ä»·æ ¼æŸ¥è¯¢', ready: '*å·¥ç¨‹é¢„ç®—*', total: 'åˆè®¡', days: 'å¤©', pct: 'åŒ¹é…ç‡', workers: 'äººå·¥', machines: 'æœºæ¢°', materials: 'ææ–™', subtotal: 'æ‘˜è¦', searching: 'æœç´¢', of: '/', not_found: 'æœªæ‰¾åˆ°', low_conf: 'éœ€æ ¸æŸ¥', price_note: 'ä»·æ ¼åŸºå‡†ï¼šä¸Šæµ· 2025', btn_calc: 'â–¶ è®¡ç®—', btn_new: '+ æ–°é¡¹ç›®', btn_lang: 'âš™ è¯­è¨€', btn_edit: 'âœ ç¼–è¾‘', btn_delete: 'âœ• åˆ é™¤', btn_add_work: '+ æ·»åŠ ', btn_done: 'âœ… å®Œæˆ', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» é‡æ–°å¼€å§‹', btn_help: '? å¸®åŠ©', loading: 'è®¡ç®—ä¸­...', more_in_html: 'è¯¦ç»†æŠ¥å‘Šå¯ç”¨', resources: 'èµ„æº', enter_work: '*æ·»åŠ é¡¹ç›®*\\næ ¼å¼ï¼šæè¿°ï¼Œæ•°é‡ å•ä½', work_added: 'âœ… å·²æ·»åŠ ', what_next: '*é€‰é¡¹:*', categories: 'ç±»åˆ«', cat_demolition: 'æ‹†é™¤', cat_rough: 'ç»“æ„', cat_finishing: 'è£…é¥°', cat_mep: 'æœºç”µ', help_title: '*æŒ‡å—*', help_text: '*ä½¿ç”¨æŒ‡å—*\\n\\n*1.* å‘é€æœ€å¤š4å¼ ç…§ç‰‡\\n*2.* æ£€æŸ¥å·¥ä½œé¡¹\\n*3.* è®¡ç®—ä»·æ ¼\\n*4.* å¯¼å‡ºç»“æœ\\n\\n/start â€” æ–°é¡¹ç›®\\n/help â€” å¸®åŠ©',\n    doc_title: 'é¢„ç®—', col_pos: 'åºå·', col_code: 'ç¼–ç ', col_desc: 'åç§°', col_unit: 'å•ä½', col_qty: 'æ•°é‡', col_price: 'å•ä»·', col_total: 'åˆè®¡', col_labor: 'å·¥æ—¶', col_quality: 'è´¨', grand_total: 'æ€»è®¡', labor_cost: 'äººå·¥è´¹', material_cost: 'ææ–™è´¹', labor_days: 'å·¥æœŸ', kpi_total: 'æ€»æˆæœ¬', kpi_hours: 'å·¥æ—¶', kpi_days: 'å·¥æœŸ', chart_cost_structure: 'æˆæœ¬ç»“æ„', chart_labor: 'äººå·¥', chart_material: 'ææ–™', chart_machines: 'æœºæ¢°', res_labor: 'äººå·¥', res_material: 'ææ–™', res_machine: 'æœºæ¢°', collapse_all: 'æŠ˜å ', expand_all: 'å±•å¼€', quality_high: 'é«˜', quality_medium: 'ä¸­', quality_low: 'ä½', export_excel_msg: 'å¯¼å‡ºExcel (CSV)', export_pdf_msg: 'å¯¼å‡ºPDF (HTML - åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¹¶æ‰“å°ä¸ºPDF)', btn_refine: 'ç²¾ç¡®åˆ†æ' },\n  'AR': { db: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'Arabic', flag: 'ğŸ‡¦ğŸ‡ª', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', cur: 'AED', sym: 'Ø¯.Ø¥', loc: 'ar-AE', region: 'Ø¯Ø¨ÙŠ', search_lang: 'Arabic',\n    ok: 'âœ… *Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©* Â· Ø¯Ø¨ÙŠ Â· AED', photo: '*Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ø£Ùˆ ÙˆØµÙ*\\n\\nÙ…Ø«Ø§Ù„ Ù„Ù„Ù†Ø³Ø®:\\n```\\nØ¬Ø¨Ø³ Ø¨ÙˆØ±Ø¯ Ø·Ø¨Ù‚ØªÙŠÙ† 25Ù…2\\nØ¨Ù„Ø§Ø· Ø¨ÙˆØ±Ø³Ù„ÙŠÙ† 60x60 Ø­Ù…Ø§Ù… 15Ù…2\\nÙ…Ø¹Ø¬ÙˆÙ† Ø§Ø³Ù‚Ù Ø¬Ø¯Ø±Ø§Ù† 120Ù…2\\nÙ…Ù‚Ø§Ø¨Ø³ Ù…Ø®ÙÙŠØ© 20 Ù‚Ø·Ø¹Ø©\\nØ¯Ù‡Ø§Ù† Ù…Ø§Ø¦ÙŠ Ø·Ø¨Ù‚ØªÙŠÙ† 80Ù…2\\n```\\n\\nØ£Ùˆ ØµÙˆØ±Ø© ğŸ“·', photo_added: 'âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', photos_count: 'ØµÙˆØ±', add_more: '+ Ø§Ù„Ù…Ø²ÙŠØ¯', analyze_now: 'â–¶ ØªØ­Ù„ÙŠÙ„', analyzing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...', found: '*Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:*', edit_hint: 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', calc: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', ready: '*Ø§Ù„ØªÙ‚Ø¯ÙŠØ±*', total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', days: 'ÙŠÙˆÙ…', pct: 'Ø§Ù„Ø¯Ù‚Ø©', workers: 'Ø¹Ù…Ø§Ù„Ø©', machines: 'Ù…Ø¹Ø¯Ø§Øª', materials: 'Ù…ÙˆØ§Ø¯', subtotal: 'Ù…Ù„Ø®Øµ', searching: 'Ø¨Ø­Ø«', of: 'Ù…Ù†', not_found: 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', low_conf: 'Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', price_note: 'Ø§Ù„Ø£Ø³Ø§Ø³: Ø¯Ø¨ÙŠ 2025', btn_calc: 'â–¶ Ø­Ø³Ø§Ø¨', btn_new: '+ Ø¬Ø¯ÙŠØ¯', btn_lang: 'âš™ Ù„ØºØ©', btn_edit: 'âœ ØªØ¹Ø¯ÙŠÙ„', btn_delete: 'âœ• Ø­Ø°Ù', btn_add_work: '+ Ø¥Ø¶Ø§ÙØ©', btn_done: 'âœ… ØªÙ…', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯', btn_help: '? Ù…Ø³Ø§Ø¹Ø¯Ø©', loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...', more_in_html: 'ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù…ØªØ§Ø­', resources: 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯', enter_work: '*Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯*\\nØ§Ù„ØµÙŠØºØ©: Ø§Ù„ÙˆØµÙØŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø©', work_added: 'âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', what_next: '*Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:*', categories: 'Ø§Ù„ÙØ¦Ø§Øª', cat_demolition: 'Ù‡Ø¯Ù…', cat_rough: 'Ù‡ÙŠÙƒÙ„', cat_finishing: 'ØªØ´Ø·ÙŠØ¨', cat_mep: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ', help_title: '*Ø¯Ù„ÙŠÙ„*', help_text: '*Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…*\\n\\n*1.* Ø£Ø±Ø³Ù„ Ø­ØªÙ‰ 4 ØµÙˆØ±\\n*2.* Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„\\n*3.* Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±\\n*4.* ØµØ¯Ù‘Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬\\n\\n/start â€” Ø¬Ø¯ÙŠØ¯\\n/help â€” Ù…Ø³Ø§Ø¹Ø¯Ø©',\n    doc_title: 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±', col_pos: 'Ø±Ù‚Ù…', col_code: 'Ø§Ù„Ø±Ù…Ø²', col_desc: 'Ø§Ù„ÙˆØµÙ', col_unit: 'ÙˆØ­Ø¯Ø©', col_qty: 'ÙƒÙ…ÙŠØ©', col_price: 'Ø³Ø¹Ø±', col_total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', col_labor: 'Ø³Ø§Ø¹Ø§Øª', col_quality: 'Ø¬', grand_total: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', labor_cost: 'Ø¹Ù…Ø§Ù„Ø©', material_cost: 'Ù…ÙˆØ§Ø¯', labor_days: 'Ø£ÙŠØ§Ù…', kpi_total: 'Ø§Ù„ØªÙƒÙ„ÙØ©', kpi_hours: 'Ø³Ø§Ø¹Ø§Øª', kpi_days: 'Ø£ÙŠØ§Ù…', chart_cost_structure: 'Ø§Ù„Ù‡ÙŠÙƒÙ„', chart_labor: 'Ø¹Ù…Ø§Ù„Ø©', chart_material: 'Ù…ÙˆØ§Ø¯', chart_machines: 'Ù…Ø¹Ø¯Ø§Øª', res_labor: 'Ø¹Ù…Ø§Ù„Ø©', res_material: 'Ù…ÙˆØ§Ø¯', res_machine: 'Ù…Ø¹Ø¯Ø§Øª', collapse_all: 'Ø·ÙŠ', expand_all: 'ØªÙˆØ³ÙŠØ¹', quality_high: 'Ø¹Ø§Ù„ÙŠØ©', quality_medium: 'Ù…ØªÙˆØ³Ø·Ø©', quality_low: 'Ù…Ù†Ø®ÙØ¶Ø©', export_excel_msg: 'ØªØµØ¯ÙŠØ± Excel (CSV)', export_pdf_msg: 'ØªØµØ¯ÙŠØ± PDF (HTML - Ø§ÙØªØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ø·Ø¨Ø¹ ÙƒÙ€ PDF)', btn_refine: 'ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ù‚' },\n  'HI': { db: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', name: 'Hindi', flag: 'ğŸ‡®ğŸ‡³', native: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', cur: 'INR', sym: 'â‚¹', loc: 'hi-IN', region: 'à¤®à¥à¤‚à¤¬à¤ˆ', search_lang: 'Hindi',\n    ok: 'âœ… *à¤¹à¤¿à¤¨à¥à¤¦à¥€* Â· à¤®à¥à¤‚à¤¬à¤ˆ Â· INR', photo: '*à¤«à¤¼à¥‹à¤Ÿà¥‹ à¤¯à¤¾ à¤µà¤¿à¤µà¤°à¤£ à¤­à¥‡à¤œà¥‡à¤‚*\\n\\nà¤•à¥‰à¤ªà¥€ à¤‰à¤¦à¤¾à¤¹à¤°à¤£:\\n```\\nà¤¡à¥à¤°à¤¾à¤ˆà¤µà¥‰à¤² 2 à¤²à¥‡à¤¯à¤° 25m2\\nà¤Ÿà¤¾à¤‡à¤²à¥à¤¸ 60x60 à¤¬à¤¾à¤¥à¤°à¥‚à¤® 15m2\\nà¤ªà¥à¤Ÿà¥à¤Ÿà¥€ à¤›à¤¤ à¤¦à¥€à¤µà¤¾à¤°à¥‡à¤‚ 120m2\\nà¤¸à¥‰à¤•à¥‡à¤Ÿ 20 à¤ªà¥€à¤¸\\nà¤ªà¥‡à¤‚à¤Ÿ 2 à¤•à¥‹à¤Ÿ 80m2\\n```\\n\\nà¤¯à¤¾ à¤«à¤¼à¥‹à¤Ÿà¥‹ ğŸ“·', photo_added: 'âœ… à¤«à¤¼à¥‹à¤Ÿà¥‹ à¤œà¥‹à¤¡à¤¼à¥€ à¤—à¤ˆ', photos_count: 'à¤«à¤¼à¥‹à¤Ÿà¥‹', add_more: '+ à¤”à¤° à¤«à¤¼à¥‹à¤Ÿà¥‹', analyze_now: 'â–¶ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£', analyzing: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£...', found: '*à¤ªà¤¹à¤šà¤¾à¤¨à¥‡ à¤—à¤ à¤•à¤¾à¤°à¥à¤¯:*', edit_hint: 'à¤¸à¤‚à¤ªà¤¾à¤¦à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥ˆà¤ª à¤•à¤°à¥‡à¤‚', calc: 'à¤®à¥‚à¤²à¥à¤¯ à¤–à¥‹à¤œ', ready: '*à¤…à¤¨à¥à¤®à¤¾à¤¨*', total: 'à¤•à¥à¤²', days: 'à¤¦à¤¿à¤¨', pct: 'à¤¸à¤Ÿà¥€à¤•à¤¤à¤¾', workers: 'à¤¶à¥à¤°à¤®', machines: 'à¤‰à¤ªà¤•à¤°à¤£', materials: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', subtotal: 'à¤¸à¤¾à¤°à¤¾à¤‚à¤¶', searching: 'à¤–à¥‹à¤œ', of: 'à¤®à¥‡à¤‚ à¤¸à¥‡', not_found: 'à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾', low_conf: 'à¤œà¤¾à¤à¤šà¥‡à¤‚', price_note: 'à¤†à¤§à¤¾à¤°: à¤®à¥à¤‚à¤¬à¤ˆ 2025', btn_calc: 'â–¶ à¤—à¤£à¤¨à¤¾', btn_new: '+ à¤¨à¤¯à¤¾', btn_lang: 'âš™ à¤­à¤¾à¤·à¤¾', btn_edit: 'âœ à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤', btn_delete: 'âœ• à¤¹à¤Ÿà¤¾à¤à¤‚', btn_add_work: '+ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚', btn_done: 'âœ… à¤¹à¥‹ à¤—à¤¯à¤¾', btn_export_excel: 'â†“ Excel', btn_export_pdf: 'â†“ PDF', btn_restart: 'â†» à¤«à¤¿à¤° à¤¸à¥‡', btn_help: '? à¤®à¤¦à¤¦', loading: 'à¤—à¤£à¤¨à¤¾...', more_in_html: 'à¤µà¤¿à¤¸à¥à¤¤à¥ƒà¤¤ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤‰à¤ªà¤²à¤¬à¥à¤§', resources: 'à¤¸à¤‚à¤¸à¤¾à¤§à¤¨', enter_work: '*à¤†à¤‡à¤Ÿà¤® à¤œà¥‹à¤¡à¤¼à¥‡à¤‚*\\nà¤ªà¥à¤°à¤¾à¤°à¥‚à¤ª: à¤µà¤¿à¤µà¤°à¤£, à¤®à¤¾à¤¤à¥à¤°à¤¾ à¤‡à¤•à¤¾à¤ˆ', work_added: 'âœ… à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾', what_next: '*à¤µà¤¿à¤•à¤²à¥à¤ª:*', categories: 'à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚', cat_demolition: 'à¤¤à¥‹à¤¡à¤¼à¤«à¥‹à¤¡à¤¼', cat_rough: 'à¤¢à¤¾à¤‚à¤šà¤¾', cat_finishing: 'à¤«à¤¼à¤¿à¤¨à¤¿à¤¶à¤¿à¤‚à¤—', cat_mep: 'MEP', help_title: '*à¤—à¤¾à¤‡à¤¡*', help_text: '*à¤‰à¤ªà¤¯à¥‹à¤— à¤—à¤¾à¤‡à¤¡*\\n\\n*1.* 4 à¤«à¤¼à¥‹à¤Ÿà¥‹ à¤¤à¤• à¤­à¥‡à¤œà¥‡à¤‚\\n*2.* à¤•à¤¾à¤°à¥à¤¯ à¤œà¤¾à¤à¤šà¥‡à¤‚\\n*3.* à¤®à¥‚à¤²à¥à¤¯ à¤—à¤£à¤¨à¤¾\\n*4.* à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¥‡à¤‚\\n\\n/start â€” à¤¨à¤¯à¤¾\\n/help â€” à¤®à¤¦à¤¦',\n    doc_title: 'à¤…à¤¨à¥à¤®à¤¾à¤¨', col_pos: 'à¤•à¥à¤°à¤®', col_code: 'à¤•à¥‹à¤¡', col_desc: 'à¤µà¤¿à¤µà¤°à¤£', col_unit: 'à¤‡à¤•à¤¾à¤ˆ', col_qty: 'à¤®à¤¾à¤¤à¥à¤°à¤¾', col_price: 'à¤¦à¤°', col_total: 'à¤•à¥à¤²', col_labor: 'à¤˜à¤‚à¤Ÿà¥‡', col_quality: 'à¤—à¥', grand_total: 'à¤•à¥à¤² à¤¯à¥‹à¤—', labor_cost: 'à¤¶à¥à¤°à¤®', material_cost: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', labor_days: 'à¤¦à¤¿à¤¨', kpi_total: 'à¤•à¥à¤² à¤²à¤¾à¤—à¤¤', kpi_hours: 'à¤˜à¤‚à¤Ÿà¥‡', kpi_days: 'à¤¦à¤¿à¤¨', chart_cost_structure: 'à¤¸à¤‚à¤°à¤šà¤¨à¤¾', chart_labor: 'à¤¶à¥à¤°à¤®', chart_material: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', chart_machines: 'à¤‰à¤ªà¤•à¤°à¤£', res_labor: 'à¤¶à¥à¤°à¤®', res_material: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', res_machine: 'à¤‰à¤ªà¤•à¤°à¤£', collapse_all: 'à¤¸à¤‚à¤•à¥à¤·à¤¿à¤ªà¥à¤¤', expand_all: 'à¤µà¤¿à¤¸à¥à¤¤à¥ƒà¤¤', quality_high: 'à¤‰à¤šà¥à¤š', quality_medium: 'à¤®à¤§à¥à¤¯à¤®', quality_low: 'à¤¨à¤¿à¤®à¥à¤¨', export_excel_msg: 'Excel à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ (CSV)', export_pdf_msg: 'PDF à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ (HTML - à¤¬à¥à¤°à¤¾à¤‰à¤œà¤¼à¤° à¤®à¥‡à¤‚ à¤–à¥‹à¤²à¥‡à¤‚ à¤”à¤° PDF à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤•à¤°à¥‡à¤‚)', btn_refine: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤¸à¥à¤§à¤¾à¤°à¥‡à¤‚' }\n};\n\nconst L = LANGS[lang] || LANGS['EN'];\nif (sd.sess && sd.sess[chatId]) { sd.sess[chatId].db = L.db; sd.sess[chatId].L = L; }\n// Get voice file ID from session if available\nconst voiceFileId = sd.sess?.[chatId]?.voiceFileId || input.voiceFileId || null;\nreturn { json: { ...input, L: L, db: L.db, voiceFileId } };"
      },
      "id": "262d9799-ea25-476b-890a-a35a63e4d3bf",
      "name": "Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        496
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_lang",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "LANG"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "lang_selected",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "LANG_OK"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_photo",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PHOTO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_analyze_options",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_OPT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "photo_added",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PHOTO_ADDED"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ANALYZE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "works_updated",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "WORKS_UPD"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_edit_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EDIT_MENU"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_new_work",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ADD_WORK"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "start_calc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CALC"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_excel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EXCEL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_help",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELP"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "view_details",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DETAILS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "refine_analysis",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "REFINE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze_text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_TEXT"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "fddf7b51-4d7d-4d51-814c-4bf740d1f1bc",
      "name": "Route",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1088,
        496
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR Cost Estimator*\\nhttps://DataDrivenConstruction.io\\n\\nâ–¸ Photo analysis (up to 4)\\nâ–¸ Text description\\nâ–¸ 9 languages Â· 55,000+ work items\\nâ–¸ Excel & PDF export\\n\\nSelect language:\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"ğŸ‡©ğŸ‡ª Deutsch\", \"callback_data\": \"lang_DE\"}, {\"text\": \"ğŸ‡¬ğŸ‡§ English\", \"callback_data\": \"lang_EN\"}, {\"text\": \"ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹\", \"callback_data\": \"lang_RU\"}],\n      [{\"text\": \"ğŸ‡ªğŸ‡¸ EspaÃ±ol\", \"callback_data\": \"lang_ES\"}, {\"text\": \"ğŸ‡«ğŸ‡· FranÃ§ais\", \"callback_data\": \"lang_FR\"}, {\"text\": \"ğŸ‡§ğŸ‡· PortuguÃªs\", \"callback_data\": \"lang_PT\"}],\n      [{\"text\": \"ğŸ‡¨ğŸ‡³ ä¸­æ–‡\", \"callback_data\": \"lang_ZH\"}, {\"text\": \"ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\", \"callback_data\": \"lang_AR\"}, {\"text\": \"ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€\", \"callback_data\": \"lang_HI\"}],\n      [{\"text\": \"â“ Help\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "47dd1f2d-0508-4364-9232-959f3791f75f",
      "name": "ğŸ“¤ Lang Menu",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "9681a75d-a6e7-4ded-b6b0-2a65b4e83f31",
      "name": "Answer Lang CB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        224
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.ok + \"\\n\\n\" + $('Config').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "e20c3d73-15d1-4658-9430-d871af3d8705",
      "name": "ğŸ“¤ Lang OK",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1552,
        224
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "43925ffa-7585-41b1-85de-0282b1c36379",
      "name": "Answer Photo CB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        368
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "e419d99f-e101-41c1-97a7-728dd272f2d3",
      "name": "ğŸ“¤ Ask Photo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1552,
        368
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": \"{{ $('Config').item.json.L.photo_added }} ({{ $('Config').item.json.photos.length }} {{ $('Config').item.json.L.photos_count }})\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $('Config').item.json.L.add_more }}\", \"callback_data\": \"add_more_photos\"}, {\"text\": \"{{ $('Config').item.json.L.analyze_now }}\", \"callback_data\": \"analyze_photos\"}],\n      [{\"text\": \"{{ $('Config').item.json.L.btn_help }}\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "7bc41667-5575-4209-a767-41c082951b13",
      "name": "ğŸ“¤ Analyze Options",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Parse Vision API response\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst data = $input.first().json;\nconst cid = String(data.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = data.L || {};\nconst provider = data.provider || 'gemini';\n\nconsole.log('=== PARSE AI DEBUG ===');\nconsole.log('Provider:', provider);\n\nlet p = { description: '', items: [] };\nlet rawContent = '';\n\ntry {\n  // Extract text from response based on provider\n  if (provider === 'openai') {\n    if (data.choices?.[0]?.message?.content) {\n      rawContent = data.choices[0].message.content;\n    } else if (data.error) {\n      console.log('OpenAI error:', JSON.stringify(data.error));\n    }\n  } else {\n    // Gemini format\n    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {\n      rawContent = data.candidates[0].content.parts[0].text;\n    } else if (data.error) {\n      console.log('Gemini error:', JSON.stringify(data.error));\n    }\n  }\n  \n  console.log('Raw AI response length:', rawContent.length);\n  console.log('Raw AI response (first 500):', rawContent.substring(0, 500));\n  \n  // Parse JSON from response\n  if (rawContent) {\n    let cleanContent = rawContent\n      .replace(/```json\\s*/gi, '')\n      .replace(/```\\s*/gi, '')\n      .trim();\n    \n    const jsonStart = cleanContent.indexOf('{');\n    const jsonEnd = cleanContent.lastIndexOf('}');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      const jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);\n      p = JSON.parse(jsonStr);\n      console.log('Parsed items count:', p.items?.length || 0);\n    }\n  }\n} catch(e) { \n  console.log('Parse error:', e.message);\n}\n\n// Validate items\nconst validItems = (p.items || [])\n  .filter(it => it.name && it.name.length > 2)\n  .map(it => ({\n    name: String(it.name).substring(0, 80).trim(),\n    qty: Math.max(0.1, parseFloat(it.qty) || 1),\n    unit: ['mÂ²', 'm', 'pcs', 'kg', 'l', 'ÑˆÑ‚', 'Ğ¼Â²', 'Ğ¼'].includes(it.unit) ? it.unit : 'mÂ²',\n    conf: ['high', 'medium', 'low'].includes(it.conf) ? it.conf : 'medium',\n    cat: ['demolition', 'rough', 'finishing', 'mep'].includes(it.cat) ? it.cat : 'finishing'\n  }));\n\n// Store in session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: data.lang };\nsd.sess[cid].works = validItems;\nsd.sess[cid].description = p.description || '';\nsd.sess[cid].state = 'wait_edit';\n\nreturn { \n  json: { \n    ...data,\n    chatId: cid, \n    works: validItems,\n    description: p.description || '',\n    L: data.L,\n    _ai_response: rawContent.substring(0, 1000),\n    _parsed_items_count: validItems.length\n  }\n};"
      },
      "id": "90654664-8769-40b6-be95-fd72c626ddae",
      "name": "Parse AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Show works from AI analysis (before Qdrant search)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || cfg.works || [];\nconst L = cfg.L;\n\nfunction shortName(str, len) {\n  str = String(str || '');\n  if (str.length > len) return str.substring(0, len - 1) + 'â€¦';\n  return str;\n}\n\nconst confMarks = { high: 'â—', medium: 'â—‹', low: 'â—Œ' };\n\nlet msg = `*${session.description || cfg.description || 'Analysis'}*\\n`;\nmsg += `${L.found}\\n`;\nmsg += `${L.edit_hint}\\n\\n`;\n\n// Simple work list\nworks.forEach((w, i) => {\n  const conf = confMarks[w.conf] || 'â—‹';\n  const num = String(i+1).padStart(2);\n  const name = shortName(w.name, 28);\n  \n  msg += `${conf} *${num}.* ${name} â€” ${w.qty}${w.unit}\\n`;\n});\n\nmsg += `\\nâ— ${L.quality_high} Â· â—‹ ${L.quality_medium} Â· â—Œ ${L.quality_low}`;\n\n// Keyboard\nconst keyboard = [];\nfor (let i = 0; i < works.length; i += 4) {\n  const row = [];\n  for (let j = 0; j < 4 && i + j < works.length; j++) {\n    row.push({ text: `âœï¸ ${i+j+1}`, callback_data: `edit_work_${i+j}` });\n  }\n  keyboard.push(row);\n}\nkeyboard.push([\n  { text: L.btn_add_work, callback_data: 'add_work' },\n  { text: L.btn_calc, callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_refine || 'ğŸ”¬ Refine', callback_data: 'refine_analysis' },\n  { text: L.btn_new, callback_data: 'new_photo' }\n]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "8ddb7704-57fa-4f13-910e-358f5688b2bb",
      "name": "Show Works",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        784
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "4b5ae27c-5a30-4075-8b35-45f320eba0fb",
      "name": "ğŸ“¤ Works",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2208,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Show edit menu for specific work\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst idx = cfg.editingWorkIndex;\nconst work = session.works?.[idx];\nconst L = cfg.L;\n\nif (!work) return { json: { ...cfg, msg: 'Work not found', keyboard: [] } };\n\nconst msg = `âœï¸ *${work.name}*\\n\\nğŸ“ ${L.col_qty}: ${work.qty} ${work.unit}\\n\\n_Adjust quantity:_`;\n\nconst keyboard = [\n  [\n    { text: '-10', callback_data: `qty_work_${idx}_minus10` },\n    { text: '-1', callback_data: `qty_work_${idx}_minus1` },\n    { text: '+1', callback_data: `qty_work_${idx}_plus1` },\n    { text: '+10', callback_data: `qty_work_${idx}_plus10` }\n  ],\n  [\n    { text: 'Ã·2', callback_data: `qty_work_${idx}_half` },\n    { text: 'Ã—2', callback_data: `qty_work_${idx}_double` }\n  ],\n  [\n    { text: L.btn_delete, callback_data: `delete_work_${idx}` },\n    { text: L.btn_done, callback_data: 'done_editing' }\n  ]\n];\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "4f981423-be36-4982-a608-6a3a3aa4d84d",
      "name": "Edit Menu",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        928
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "58be3993-bc31-4f7c-92f6-660bd2a63173",
      "name": "ğŸ“¤ Edit Menu",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1552,
        928
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.enter_work) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "b4c73cf7-0c86-4a8b-9918-267197c4179b",
      "name": "ğŸ“¤ Ask New Work",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        1072
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Works updated - wider name column\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L;\n\nfunction pad(str, len) {\n  str = String(str || '');\n  if (str.length > len) str = str.substring(0, len - 1) + 'â€¦';\n  return str + ' '.repeat(Math.max(0, len - str.length));\n}\n\nconst confMarks = { high: 'â—', medium: 'â—‹', low: 'â—Œ' };\n\nlet msg = `âœ… ${L.work_added || 'Updated'}\\n\\n`;\nmsg += `${L.found}\\n\\n`;\n\nmsg += '```\\n';\nworks.forEach((w, i) => {\n  const conf = confMarks[w.conf] || 'â—‹';\n  const name = pad(w.name || '', 22);\n  const num = String(i+1).padStart(2);\n  msg += `${num} ${conf} ${name} ${w.qty}${w.unit}\\n`;\n});\nmsg += '```\\n\\n';\nmsg += `_${works.length} items_\\n`;\n\nconst keyboard = [];\nfor (let i = 0; i < works.length; i += 4) {\n  const row = [];\n  for (let j = 0; j < 4 && i + j < works.length; j++) {\n    row.push({ text: `âœï¸ ${i+j+1}`, callback_data: `edit_work_${i+j}` });\n  }\n  keyboard.push(row);\n}\nkeyboard.push([\n  { text: L.btn_add_work, callback_data: 'add_work' },\n  { text: L.btn_calc, callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_new, callback_data: 'new_photo' }\n]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "8b75897d-88c5-4c6e-b436-67db8b906dcd",
      "name": "Works Updated",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1216
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "dbc9a788-ccd9-44f9-8e80-2d05fbb13081",
      "name": "ğŸ“¤ Works Updated",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1552,
        1216
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\",\n  \"text\": \"{{ $('Config').item.json.L.loading }}\",\n  \"show_alert\": false\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "d64b1788-1dfa-4bef-b50d-ee54c5dcb076",
      "name": "Answer Calc CB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        1344
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Prepare works for Qdrant search loop\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $input.first().json; // From Save Progress ID (contains full config)\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst db = session.db || cfg.db;\nconst L = session.L || cfg.L;\n\n// Clear previous results\nif (sd.res) delete sd.res[cid];\n\nconst totalWorks = works.length;\n\nconsole.log('Prep Works: Processing', totalWorks, 'works');\n\n// Return array of work items for Loop\nreturn works.map((w, idx) => ({ \n  json: { \n    ...w, \n    db, \n    L, \n    bot_token: cfg.bot_token, \n    chatId: cid, \n    sq: w.query || w.name, \n    work_index: idx + 1, \n    total_works: totalWorks \n  } \n}));"
      },
      "id": "300f2972-a3e0-4848-83a4-272b9490e9e7",
      "name": "Prep Works",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1552,
        1344
      ]
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "08c45de8-4138-4ed4-aa7f-b5822044102f",
      "name": "Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1776,
        1344
      ]
    },
    {
      "parameters": {
        "model": "text-embedding-3-large",
        "options": {
          "dimensions": 3072
        }
      },
      "id": "cbf8505a-424e-493d-b749-c5e7314543c9",
      "name": "Embed",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2000,
        1504
      ],
      "credentials": {
        "openAiApi": {
          "id": "8rh2SAsSlVPdcnR7",
          "name": "OpenAi n8n"
        }
      }
    },
    {
      "parameters": {
        "mode": "load",
        "qdrantCollection": {
          "__rl": true,
          "value": "={{ $json.db }}",
          "mode": "id"
        },
        "prompt": "={{ $json.sq }}",
        "topK": 5,
        "options": {}
      },
      "id": "016666b7-efcd-4602-b87f-c7d7710d2e20",
      "name": "Qdrant",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1.1,
      "position": [
        2000,
        1344
      ],
      "credentials": {
        "qdrantApi": {
          "id": "TcaDCjTrrbu8jxg4",
          "name": "QdrantApi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Parse Qdrant results - FIXED unit cost calculation\nconst searchResults = $input.all();\nconst loopItem = $('Loop').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = loopItem.chatId;\nconst L = loopItem.L || {};\nconst workIndex = loopItem.work_index || 1;\nconst totalWorks = loopItem.total_works || 1;\n\n// Progress update removed - $http not available in Code node\n\nconst MACHINE_PATTERNS = ['masch', 'maschinenstunde', 'gerÃ¤t', 'machine', 'equipment', 'Ğ¼Ğ°ÑˆĞ¸Ğ½', 'Ğ¼Ğ°Ñˆ-Ñ‡', 'Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼', 'æœºæ¢°', 'è®¾å¤‡', 'kran', 'vibr', 'bagger', 'lader', 'hebe', 'mixer', 'pump'];\nconst LABOR_PATTERNS = ['std', 'stunde', 'arbeiter', 'hour', 'man-hour', 'labor', 'Ñ‡-Ñ‡', 'Ñ‡ĞµĞ»-Ñ‡', 'Ñ‚Ñ€ÑƒĞ´', 'Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹', 'Ñ€Ğ°Ğ·Ñ€ÑĞ´', 'å·¥æ—¶', 'äººå·¥', 'lohn', 'worker', 'facharbeiter'];\n\nfunction detectResourceType(unit, name, code) {\n  const combined = ((unit || '') + ' ' + (name || '') + ' ' + (code || '')).toLowerCase();\n  if (MACHINE_PATTERNS.some(p => combined.includes(p.toLowerCase()))) return 'machine';\n  if (LABOR_PATTERNS.some(p => combined.includes(p.toLowerCase()))) return 'labor';\n  return 'material';\n}\n\nif (!searchResults || searchResults.length === 0) {\n  console.log('=== PARSE Q: No results from Qdrant ===');\n  console.log('Work:', loopItem.name);\n  return [{ json: { ...loopItem, rate_code: 'NOT_FOUND', rate_name: loopItem.name, rate_unit: loopItem.unit, uc: 0, tc: 0, ql: 'not_found', quality_score: 0, resources: [], labor_hours: 0, cost_breakdown: { workers: 0, machines: 0, materials: 0 } }}];\n}\n\n// Log raw Qdrant results\nconsole.log('=== RAW QDRANT RESULTS ===');\nsearchResults.slice(0, 2).forEach((item, idx) => {\n  const data = item.json || {};\n  const doc = data.document || {};\n  console.log('Result ' + idx + ':');\n  console.log('  Score:', data.score);\n  console.log('  Content (first 500):', String(doc.pageContent || doc.content || data.pageContent || '').substring(0, 500));\n  console.log('  Metadata keys:', Object.keys(doc.metadata || data.metadata || {}));\n});\n\nconst parsedResults = searchResults.map((item) => {\n  const data = item.json || {};\n  const doc = data.document || {};\n  const content = String(doc.pageContent || doc.content || data.pageContent || '');\n  const metadata = doc.metadata || data.metadata || {};\n  const score = data.score || 0;\n  \n  let allText = content;\n  Object.values(metadata).forEach(v => { if (typeof v === 'string' && v.length > 20) allText += '\\n' + v; });\n  \n  // Extract rate info\n  let rateCode = metadata.rsts || metadata.code || metadata.rate_code || '';\n  let rateName = metadata.names || metadata.name || metadata.rate_name || '';\n  let rateUnit = metadata.unit || metadata.rate_unit || '';\n  \n  if (!rateCode) { const m = allText.match(/(?:CODE|Ğ¨Ğ¸Ñ„Ñ€|Code)[:\\s]*([A-ZĞ-Ğ¯a-zĞ°-Ñ0-9_-]+)/i); if (m) rateCode = m[1]; }\n  if (!rateName) { const m = allText.match(/(?:NAME|ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ|Name)[:\\s]*(.+?)(?:\\n|$)/i); if (m) rateName = m[1].trim(); }\n  if (!rateUnit) { const m = allText.match(/(?:UNIT|Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ°|Unit)[:\\s]*(.+?)(?:\\n|$)/i); if (m) rateUnit = m[1].trim(); }\n  \n  // Parse resources with PRICES - improved patterns\n  const resources = [];\n  let laborCost = 0, machineCost = 0, materialCost = 0;\n  let laborHours = 0;\n  \n  // Pattern 1: CODE â€” Name â€” Qty Unit (Preis=X, Kosten=Y)\n  const resRegex1 = /([A-ZĞ-Ğ¯][A-ZĞ-Ğ¯a-zĞ°-Ñ0-9_-]{2,})\\s*[â€”â€“-]\\s*([^â€”â€“-]+?)\\s*[â€”â€“-]\\s*([0-9.,]+)\\s+([^(\\n]+?)\\s*\\((?:Preis|Price|Ğ¦ĞµĞ½Ğ°)\\s*=\\s*([0-9.,]+)\\s*,\\s*(?:Kosten|Cost|Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)\\s*=\\s*([0-9.,]+)\\s*\\)/gi;\n  let m;\n  while ((m = resRegex1.exec(allText)) !== null) {\n    const code = m[1].trim(), name = m[2].trim();\n    const qty = parseFloat(m[3].replace(',', '.')) || 0;\n    const unit = m[4].trim();\n    const price = parseFloat(m[5].replace(',', '.')) || 0;\n    const cost = parseFloat(m[6].replace(',', '.')) || 0;\n    const type = detectResourceType(unit, name, code);\n    if (code && name && cost > 0) {\n      resources.push({ resource_code: code, resource_name: name, resource_quantity: qty, resource_unit: unit, resource_price: price, resource_cost: cost, resource_type: type });\n      if (type === 'labor') { laborCost += cost; if (unit.toLowerCase().includes('std') || unit.toLowerCase().includes('Ñ‡')) laborHours += qty; }\n      else if (type === 'machine') machineCost += cost; \n      else materialCost += cost;\n    }\n  }\n  \n  // Pattern 2: Simpler - CODE â€” Name â€” Qty Unit = Cost or Cost â‚¬ \n  if (resources.length === 0) {\n    const resRegex2 = /([A-ZĞ-Ğ¯][A-ZĞ-Ğ¯a-zĞ°-Ñ0-9_-]{3,})\\s*[â€”â€“-]\\s*([^â€”â€“\\n]{5,50})\\s*[â€”â€“-]\\s*([0-9.,]+)\\s*([A-Za-zĞ-Ğ¯Ğ°-ÑÂ²Â³.\\-\\s]{1,20})\\s*[=]\\s*([0-9.,]+)/gi;\n    while ((m = resRegex2.exec(allText)) !== null) {\n      const code = m[1].trim(), name = m[2].trim();\n      const qty = parseFloat(m[3].replace(',', '.')) || 0;\n      const unit = m[4].trim();\n      const cost = parseFloat(m[5].replace(',', '.')) || 0;\n      const type = detectResourceType(unit, name, code);\n      const price = qty > 0 ? cost / qty : 0;\n      if (name.length > 3 && cost > 0) {\n        resources.push({ resource_code: code, resource_name: name, resource_quantity: qty, resource_unit: unit, resource_price: price, resource_cost: cost, resource_type: type });\n        if (type === 'labor') { laborCost += cost; if (unit.toLowerCase().includes('std') || unit.toLowerCase().includes('Ñ‡')) laborHours += qty; }\n        else if (type === 'machine') machineCost += cost; \n        else materialCost += cost;\n      }\n    }\n  }\n  \n  // Pattern 3: Lines with price format - Resource name: Qty Unit Ã— Price = Cost\n  if (resources.length === 0) {\n    const lines = allText.split('\\n');\n    for (const line of lines) {\n      // Match: Name Qty Unit Ã— Price = Cost or Name Qty Unit = Cost\n      const m1 = line.match(/([A-ZĞ-Ğ¯a-zĞ°-Ñ][A-ZĞ-Ğ¯Ğ°-Ñ0-9\\s,.-]{5,40})[:\\s]+([0-9.,]+)\\s*([A-Za-zĞ-Ğ¯Ğ°-ÑÂ²Â³.\\-]+)\\s*[Ã—x]\\s*([0-9.,]+)\\s*[â‚¬â‚½$]?\\s*=\\s*([0-9.,]+)/i);\n      if (m1) {\n        const name = m1[1].trim();\n        const qty = parseFloat(m1[2].replace(',', '.')) || 0;\n        const unit = m1[3].trim();\n        const price = parseFloat(m1[4].replace(',', '.')) || 0;\n        const cost = parseFloat(m1[5].replace(',', '.')) || 0;\n        const type = detectResourceType(unit, name, '');\n        if (cost > 0) {\n          resources.push({ resource_code: '', resource_name: name, resource_quantity: qty, resource_unit: unit, resource_price: price, resource_cost: cost, resource_type: type });\n          if (type === 'labor') { laborCost += cost; if (unit.toLowerCase().includes('std') || unit.toLowerCase().includes('Ñ‡')) laborHours += qty; }\n          else if (type === 'machine') machineCost += cost; \n          else materialCost += cost;\n        }\n      }\n    }\n  }\n  \n  console.log('Resources parsed:', resources.length, '- Labor:', laborCost, 'Mat:', materialCost, 'Machine:', machineCost);\n\n// Extract explicit total cost if mentioned\n  let explicitTotalCost = 0;\n  const costPatterns = [\n    /(?:Total\\s*cost|Gesamtkosten|Ğ˜Ğ¢ĞĞ“Ğ|Ğ’ÑĞµĞ³Ğ¾)[:\\s]*([0-9][0-9\\s.,]*)\\s*[â‚¬â‚½$]?/i,\n    /(?:Kosten|Cost|Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)\\s*=\\s*([0-9][0-9.,]*)/i\n  ];\n  for (const pattern of costPatterns) {\n    const match = allText.match(pattern);\n    if (match) { \n      explicitTotalCost = parseFloat(match[1].replace(/\\s/g, '').replace(',', '.')) || 0;\n      if (explicitTotalCost > 0) break;\n    }\n  }\n  \n  // Calculate total cost from resources or use explicit\n  const resourcesTotal = laborCost + machineCost + materialCost;\n  let totalCost = resourcesTotal > 0 ? resourcesTotal : explicitTotalCost;\n  \n  // If we have resources but no costs, try to extract prices differently\n  if (resources.length === 0 && totalCost === 0) {\n    // Look for any number that looks like a total cost (larger than 10)\n    const bigNumbers = allText.match(/([0-9]{2,}[.,][0-9]{2})\\s*[â‚¬â‚½$]/g) || [];\n    const costs = bigNumbers.map(n => parseFloat(n.replace(/[â‚¬â‚½$\\s]/g, '').replace(',', '.'))).filter(n => n > 10);\n    if (costs.length > 0) {\n      totalCost = Math.max(...costs);\n      // Estimate breakdown\n      laborCost = totalCost * 0.4;\n      materialCost = totalCost * 0.5;\n      machineCost = totalCost * 0.1;\n    }\n  }\n  \n  // Quality score\n  let qualityScore = 0;\n  if (totalCost > 0) qualityScore += 35;\n  if (resources.length > 0) qualityScore += Math.min(25, resources.length * 5);\n  if (rateCode) qualityScore += 15;\n  if (rateName) qualityScore += 15;\n  if (score > 0.4) qualityScore += 10;\n  \n  return { \n    rate_code: rateCode, \n    rate_name: rateName, \n    rate_unit: rateUnit, \n    total_cost: totalCost,\n    resources_total: resourcesTotal,\n    labor_hours: laborHours, \n    resources, \n    quality_score: qualityScore, \n    cost_breakdown: { workers: laborCost, machines: machineCost, materials: materialCost } \n  };\n});\n\nconst best = parsedResults.sort((a, b) => b.quality_score - a.quality_score)[0] || {};\nlet qualityLevel = best.quality_score >= 55 ? 'high' : best.quality_score >= 30 ? 'medium' : best.quality_score >= 10 ? 'low' : 'not_found';\n\nconst qty = loopItem.qty || 0;\n\n// Handle unit conversion (100 mÂ², 10 mÂ², etc.)\nlet unitDivisor = 1;\nconst rateUnit = (best.rate_unit || '').toLowerCase();\nif (rateUnit.includes('100')) unitDivisor = 100;\nelse if (rateUnit.match(/10\\s/)) unitDivisor = 10;\n\n// IMPORTANT: uc should be the TOTAL cost per rate unit, not divided\n// If rate_unit = \"100 mÂ²\" and total_cost is for 100 mÂ², uc = total_cost\n// Then for qty = 25 mÂ², tc = (25/100) Ã— uc = 0.25 Ã— total_cost\nconst uc = best.total_cost || 0;\nconst quantityInRateUnits = qty / unitDivisor;\nconst tc = quantityInRateUnits * uc;\n\n// Labor hours scaled\nconst laborHours = (best.labor_hours || 0) * quantityInRateUnits;\n\n// Cost breakdown scaled\nconst cb = best.cost_breakdown || { workers: 0, machines: 0, materials: 0 };\nconst workersTotal = cb.workers * quantityInRateUnits;\nconst machinesTotal = cb.machines * quantityInRateUnits;\nconst materialsTotal = cb.materials * quantityInRateUnits;\n\n// Scale resources\nconst scaledResources = (best.resources || []).map(r => ({ \n  ...r, \n  scaled_quantity: (r.resource_quantity || 0) * quantityInRateUnits, \n  scaled_cost: (r.resource_cost || 0) * quantityInRateUnits \n}));\n\nconsole.log('=== PARSE Q RESULT ===');\nconsole.log('Work:', loopItem.name);\nconsole.log('Rate found:', best.rate_code, '- Quality:', best.quality_score);\nconsole.log('Resources found:', scaledResources.length);\nif (scaledResources.length > 0) {\n  console.log('First 3 resources:');\n  scaledResources.slice(0, 3).forEach((r, i) => {\n    console.log('  ' + (i+1) + '. ' + r.resource_type + ': ' + r.resource_name + ' - ' + r.scaled_cost);\n  });\n}\nconsole.log('Total cost:', tc, 'Unit cost:', uc);\nconsole.log('Breakdown: Labor:', workersTotal, 'Mat:', materialsTotal, 'Mach:', machinesTotal);\n\nreturn [{ json: { \n  ...loopItem, \n  rate_code: best.rate_code || 'NOT_FOUND', \n  rate_name: best.rate_name || loopItem.name, \n  rate_unit: best.rate_unit || loopItem.unit, \n  uc, \n  tc, \n  labor_hours: laborHours, \n  workers_total: workersTotal, \n  machines_total: machinesTotal, \n  materials_total: materialsTotal, \n  ql: qualityLevel, \n  quality_score: best.quality_score || 0, \n  resources: scaledResources, \n  cost_breakdown: { \n    workers: workersTotal, \n    machines: machinesTotal, \n    materials: materialsTotal \n  } \n}}];"
      },
      "id": "47344095-3789-4248-8656-5ba8ae84a9cd",
      "name": "Parse Q",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        1344
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sd = $getWorkflowStaticData('global');\nconst w = $input.first().json;\nconst cid = w.chatId;\nif (!sd.res) sd.res = {};\nif (!sd.res[cid]) sd.res[cid] = [];\nsd.res[cid].push(w);\nreturn { json: w };"
      },
      "id": "29551362-429a-434d-8fab-68998246a1ef",
      "name": "Acc",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2432,
        1344
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Aggregate results - recalculate tc from resources\nconst results = $input.all();\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\n\n// Progress message cleanup removed - handled elsewhere\n\nconst L = cfg.L || {};\nlet total = 0, workers_sum = 0, materials_sum = 0, machines_sum = 0, labor_hours_sum = 0;\nlet found_count = 0;\n\nconst works = results.map(r => {\n  const w = r.json;\n  \n  // Calculate tc from resources if available\n  let tc = w.tc || 0;\n  let workersTotal = w.workers_total || 0;\n  let materialsTotal = w.materials_total || 0;\n  let machinesTotal = w.machines_total || 0;\n  let workLaborHours = w.labor_hours || 0;\n  \n  // Sum up scaled_cost from resources\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    let laborSum = 0, matSum = 0, machSum = 0, laborHours = 0;\n    \n    resources.forEach(res => {\n      const cost = res.scaled_cost || res.resource_cost || 0;\n      \n      // Extract labor hours from resource\n      // Labor resources usually have norma (norm time) or qty that represents hours\n      if (res.resource_type === 'labor') {\n        laborSum += cost;\n        // Labor hours = scaled quantity of labor resource\n        const hours = res.scaled_qty || res.resource_qty || 0;\n        laborHours += hours;\n      }\n      else if (res.resource_type === 'machine') {\n        machSum += cost;\n      }\n      else {\n        matSum += cost;\n      }\n    });\n    \n    // If we have resource costs, use them\n    if (laborSum + matSum + machSum > 0) {\n      workersTotal = laborSum;\n      materialsTotal = matSum;\n      machinesTotal = machSum;\n      tc = laborSum + matSum + machSum;\n    }\n    \n    // Use labor hours from resources if available\n    if (laborHours > 0) {\n      workLaborHours = laborHours;\n    }\n  }\n  \n  // Fallback: estimate labor hours from cost (rough estimate: â‚¬30/hour average)\n  if (workLaborHours === 0 && workersTotal > 0) {\n    workLaborHours = workersTotal / 30;\n  }\n  \n  // Recalculate uc from tc\n  const uc = w.qty > 0 ? tc / w.qty : 0;\n  \n  total += tc;\n  workers_sum += workersTotal;\n  materials_sum += materialsTotal;\n  machines_sum += machinesTotal;\n  labor_hours_sum += workLaborHours;\n  if (w.ql !== 'not_found') found_count++;\n  \n  return { \n    ...w, \n    tc, \n    uc,\n    workers_total: workersTotal, \n    materials_total: materialsTotal, \n    machines_total: machinesTotal,\n    labor_hours: workLaborHours\n  };\n});\n\nconst pct = works.length > 0 ? Math.round(found_count / works.length * 100) : 0;\n\n// Store for later use\nsd.lastResults = { works, total, workers_sum, materials_sum, machines_sum, labor_hours_sum, found_count, pct, L };\n\n// Get progress message ID for deletion and clean up\nconst progressMsgId = sd.progress?.[cid]?.message_id || 0;\nif (sd.progress?.[cid]) {\n  delete sd.progress[cid];\n}\n\nreturn { json: { \n  chatId: cid, \n  bot_token: cfg.bot_token, \n  works, \n  total, \n  workers_sum, \n  materials_sum, \n  machines_sum, \n  labor_hours_sum, \n  found_count, \n  pct, \n  L,\n  description: sd.sess?.[cid]?.description || '',\n  progress_message_id: progressMsgId\n}};"
      },
      "id": "a77244b2-4245-4a34-a2b4-e0d3b3618ae0",
      "name": "Agg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        1216
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Generate HTML Report with expandable resources\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $('Agg').first().json;\nconst L = d.L || {};\nconst cur = L.cur || 'USD'; \nconst loc = L.loc || 'en'; \nconst sym = L.sym || '$';\nconst works = d.works || []; \nconst total = d.total || 0;\n\nfunction fmt(v) { \n  try { \n    return new Intl.NumberFormat(loc, { style: 'currency', currency: cur, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0); \n  } catch(e) { \n    return sym + ' ' + (v || 0).toFixed(2); \n  } \n}\nfunction fmtNum(v, dec) { \n  return new Intl.NumberFormat(loc, { minimumFractionDigits: dec || 2, maximumFractionDigits: dec || 2 }).format(v || 0); \n}\nfunction esc(t) { \n  return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); \n}\n\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' });\nconst timeStr = now.toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' });\n\nconst laborPct = total > 0 ? Math.round(d.workers_sum / total * 100) : 0;\nconst materialPct = total > 0 ? Math.round(d.materials_sum / total * 100) : 0;\nconst machinePct = total > 0 ? Math.round(d.machines_sum / total * 100) : 0;\nconst laborDays = Math.ceil((d.labor_hours_sum || 0) / 8);\n\nlet html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\">\n<title>${esc(L.doc_title || 'Cost Estimate')} - ${esc(d.description || '')}</title>\n<style>\n:root{--primary:#007AFF;--text:#1D1D1F;--text2:#86868B;--text3:#AEAEB2;--bg:#FFF;--bg2:#F5F5F7;--bg3:#E8E8ED;--border:#D2D2D7;--labor:#E3F2FD;--labor-text:#1565C0;--material:#FFF3E0;--material-text:#E65100;--machine:#F3E5F5;--machine-text:#7B1FA2}\n*{box-sizing:border-box}\nbody{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg2);color:var(--text);font-size:12px;line-height:1.4}\n.container{background:var(--bg);max-width:1200px;margin:0 auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}\n.header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}\n.header h1{margin:0;font-size:18px;font-weight:600}\n.header-info{font-size:11px;color:var(--text3)}\n.toolbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}\n.btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:11px}\n.btn:hover{background:var(--bg3)}\n.kpi{display:flex;gap:8px;padding:12px 20px;background:var(--bg2);flex-wrap:wrap}\n.kpi-card{background:var(--bg);border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:100px}\n.kpi-value{font-size:16px;font-weight:600}\n.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase}\ntable{width:100%;border-collapse:collapse}\nth,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}\nth{background:var(--bg2);font-weight:500;font-size:10px;text-transform:uppercase;color:var(--text2)}\n.work-row{cursor:pointer;transition:background 0.15s}\n.work-row:hover{background:var(--bg2)}\n.work-row td:first-child{font-weight:500}\n.toggle{width:20px;color:var(--text3);font-size:10px}\n.res-row{background:#FAFAFA;font-size:11px}\n.res-row.hidden{display:none}\n.res-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed var(--border)}\n.res-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:500;margin-right:6px}\n.res-labor{background:var(--labor);color:var(--labor-text)}\n.res-material{background:var(--material);color:var(--material-text)}\n.res-machine{background:var(--machine);color:var(--machine-text)}\n.summary-row{background:linear-gradient(90deg,var(--bg2),var(--bg));font-size:10px}\n.summary-row.hidden{display:none}\n.summary-row td{padding:6px 10px 6px 30px;border-top:1px solid var(--border)}\n.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}\n.dot-high{background:#34C759}\n.dot-medium{background:#FF9500}\n.dot-low{background:#FF3B30}\n.dot-none{background:#8E8E93}\n.total-row{background:var(--bg2);font-weight:600}\n.total-row td{padding:12px 10px}\n.right{text-align:right}\n.footer{padding:16px 20px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border)}\n.footer a{color:var(--primary);text-decoration:none}\n@media(max-width:600px){\n  body{padding:8px;font-size:11px}\n  th,td{padding:6px}\n  .kpi-card{min-width:80px;padding:8px}\n  .kpi-value{font-size:14px}\n}\n</style>\n</head><body>\n<div class=\"container\">\n<div class=\"header\">\n  <h1>${esc(L.doc_title || 'Cost Estimate')}</h1>\n  <div class=\"header-info\">${dateStr} ${timeStr} Â· ${esc(L.region || '')}</div>\n</div>\n<div class=\"toolbar\">\n  <button class=\"btn\" onclick=\"expandAll()\">${esc(L.expand_all || 'Expand All')}</button>\n  <button class=\"btn\" onclick=\"collapseAll()\">${esc(L.collapse_all || 'Collapse All')}</button>\n</div>\n<div class=\"kpi\">\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${fmt(total)}</div><div class=\"kpi-label\">${esc(L.kpi_total || 'Total')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${works.length}</div><div class=\"kpi-label\">${esc(L.kpi_items || 'Items')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborDays}d</div><div class=\"kpi-label\">${esc(L.kpi_days || 'Days')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborPct}%</div><div class=\"kpi-label\">${esc(L.workers || 'Labor')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${materialPct}%</div><div class=\"kpi-label\">${esc(L.materials || 'Materials')}</div></div>\n</div>\n<table>\n<tr>\n  <th style=\"width:30px\"></th>\n  <th>${esc(L.col_code || 'Code')}</th>\n  <th>${esc(L.col_desc || 'Description')}</th>\n  <th>${esc(L.col_unit || 'Unit')}</th>\n  <th class=\"right\">${esc(L.col_qty || 'Qty')}</th>\n  <th class=\"right\">${esc(L.col_price || 'Price')}</th>\n  <th class=\"right\">${esc(L.col_total || 'Total')}</th>\n  <th style=\"width:30px\"></th>\n</tr>`;\n\nworks.forEach((w, i) => {\n  console.log('Work ' + (i+1) + ': ' + (w.rate_name || w.name) + ' - Resources: ' + (w.resources || []).length);\n  const hasRes = (w.resources || []).length > 0;\n  const isFirst = i === 0;\n  const dotClass = w.ql === 'high' ? 'dot-high' : w.ql === 'medium' ? 'dot-medium' : w.ql === 'low' ? 'dot-low' : 'dot-none';\n  const code = w.rate_code && w.rate_code !== 'NOT_FOUND' ? w.rate_code : 'â€”';\n  \n  html += `<tr class=\"work-row\" data-work=\"${i}\" onclick=\"toggleWork(${i})\">\n    <td class=\"toggle\"><span id=\"icon-${i}\">${isFirst ? 'â–¼' : 'â–¶'}</span></td>\n    <td style=\"font-size:10px;color:var(--text2)\">${esc(code)}</td>\n    <td><strong>${esc(w.rate_name || w.name)}</strong></td>\n    <td>${esc(w.rate_unit || w.unit)}</td>\n    <td class=\"right\">${fmtNum(w.qty)}</td>\n    <td class=\"right\">${fmt(w.uc)}</td>\n    <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n    <td><span class=\"dot ${dotClass}\"></span></td>\n  </tr>`;\n  \n  // Resources\n  const resources = w.resources || [];\n  resources.forEach((r, ri) => {\n    const tagClass = r.resource_type === 'labor' ? 'res-labor' : r.resource_type === 'machine' ? 'res-machine' : 'res-material';\n    const tagLabel = r.resource_type === 'labor' ? (L.res_labor || 'Labor') : r.resource_type === 'machine' ? (L.res_machine || 'Equip') : (L.res_material || 'Mat');\n    const hiddenClass = isFirst ? '' : 'hidden';\n    const resQty = r.scaled_quantity || r.resource_quantity || 0;\n    const resPrice = r.resource_price || 0;\n    const resCost = r.scaled_cost || 0;\n    const norm = r.resource_quantity || r.norma || 0;\n    const pct = w.tc > 0 ? Math.round(resCost / w.tc * 100) : 0;\n    \n    html += `<tr class=\"res-row ${hiddenClass}\" data-work=\"${i}\">\n      <td></td>\n      <td><span style=\"font-size:9px;color:var(--text3)\">${esc(r.resource_code || '')}</span></td>\n      <td>\n        <span class=\"res-tag ${tagClass}\">${esc(tagLabel)}</span>\n        ${esc(r.resource_name || '')}\n        ${norm ? '<span style=\"color:var(--text3);font-size:9px;margin-left:4px\">Ã—' + fmtNum(norm, 4) + '</span>' : ''}\n      </td>\n      <td style=\"font-size:10px\">${esc(r.resource_unit || '')}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmtNum(resQty, 3)}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmt(resPrice)}</td>\n      <td class=\"right\">${fmt(resCost)} <span style=\"font-size:9px;color:var(--text3)\">${pct}%</span></td>\n      <td></td>\n    </tr>`;\n  });\n  \n  // Summary row for work\n  if (resources.length > 0) {\n    const laborSum = resources.filter(r => r.resource_type === 'labor').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const matSum = resources.filter(r => r.resource_type === 'material').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const machSum = resources.filter(r => r.resource_type === 'machine').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const hiddenClass = isFirst ? '' : 'hidden';\n    \n    html += `<tr class=\"summary-row ${hiddenClass}\" data-work=\"${i}\">\n      <td colspan=\"2\"></td>\n      <td colspan=\"4\">\n        <span style=\"color:var(--labor-text)\">${L.workers || 'Labor'}: ${fmt(laborSum)}</span> Â· \n        <span style=\"color:var(--material-text)\">${L.materials || 'Mat'}: ${fmt(matSum)}</span> Â· \n        <span style=\"color:var(--machine-text)\">${L.machines || 'Equip'}: ${fmt(machSum)}</span>\n      </td>\n      <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n      <td></td>\n    </tr>`;\n  }\n});\n\nhtml += `<tr class=\"total-row\">\n  <td colspan=\"6\" style=\"text-align:right\">${esc(L.grand_total || 'TOTAL')}</td>\n  <td class=\"right\">${fmt(total)}</td>\n  <td></td>\n</tr>\n</table>\n<div class=\"footer\">\n  <a href=\"https://DataDrivenConstruction.io\" target=\"_blank\">DDC CWICR</a> Â· \n  Open Source Construction Cost Database Â· ${dateStr}\n</div>\n</div>\n<script>\nfunction toggleWork(idx) {\n  const icon = document.getElementById('icon-' + idx);\n  const rows = document.querySelectorAll('tr[data-work=\"' + idx + '\"]:not(.work-row)');\n  const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');\n  rows.forEach(r => r.classList.toggle('hidden', !isHidden));\n  if (icon) icon.textContent = isHidden ? 'â–¼' : 'â–¶';\n}\nfunction expandAll() {\n  document.querySelectorAll('tr[data-work]').forEach(r => r.classList.remove('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = 'â–¼');\n}\nfunction collapseAll() {\n  document.querySelectorAll('tr.res-row, tr.summary-row').forEach(r => r.classList.add('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = 'â–¶');\n}\n</script>\n</body></html>`;\n\nconst sd = $getWorkflowStaticData('global');\nsd.html_report = html;\n\nreturn { json: { ...d, html_content: html } };"
      },
      "id": "2979ed26-b8ad-47e7-91ff-5085e023248f",
      "name": "Generate HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        1216
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Final message with resources preview\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $('Generate HTML').first().json;\nconst cid = d.chatId;\nconst sd = $getWorkflowStaticData('global');\nconst L = d.L || {};\n\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.sess?.[cid]) sd.sess[cid].state = 'done';\n\nfunction fmt(v) { \n  try { return new Intl.NumberFormat(L.loc || 'en', { maximumFractionDigits: 0 }).format(v || 0); } \n  catch(e) { return (v || 0).toFixed(0); } \n}\nfunction fmtCur(v) { \n  const sym = L.sym || '$';\n  if (Math.abs(v) >= 1000) return sym + ' ' + fmt(v);\n  return sym + ' ' + (v || 0).toFixed(2);\n}\nfunction shortName(str, len) {\n  str = String(str || '');\n  if (str.length > len) return str.substring(0, len - 1) + '...';\n  return str;\n}\n\nconst works = d.works || [];\nconst total = d.total || 0;\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(L.loc || 'en', { year: 'numeric', month: '2-digit', day: '2-digit' });\n\nconst qiMarks = { 'high': 'â—', 'medium': 'â—‹', 'low': 'â—Œ', 'not_found': 'âœ•' };\n\n// Header\nlet msg = `*${L.doc_title || 'COST ESTIMATE'}*\\n`;\nmsg += `${dateStr} Â· ${L.region || ''}\\n\\n`;\n\n// Works with resources\nworks.forEach((w, i) => {\n  const qi = qiMarks[w.ql] || 'â—‹';\n  const name = shortName(w.rate_name || w.name || '', 30);\n  const sumStr = fmtCur(w.tc);\n  \n  msg += `${qi} *${i+1}.* ${name}\\n`;\n  msg += `   ${w.qty} ${w.unit} Ã— ${fmtCur(w.uc)} = *${sumStr}*\\n`;\n  \n  // Show 2-3 resources\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    const preview = resources.slice(0, 3);\n    preview.forEach((r, ri) => {\n      const isLast = ri === preview.length - 1 && resources.length <= 3;\n      const prefix = isLast ? 'â””' : 'â”œ';\n      const typeIcon = r.resource_type === 'labor' ? 'L' : r.resource_type === 'machine' ? 'M' : 'R';\n      const rName = shortName(r.resource_name || '', 18);\n      const rCost = fmtCur(r.scaled_cost || 0);\n      msg += `   ${prefix} [${typeIcon}] ${rName} ${rCost}\\n`;\n    });\n    if (resources.length > 3) {\n      msg += `   â”” +${resources.length - 3} ${L.more_resources || 'more'}\\n`;\n    }\n  }\n});\n\n// Total\nmsg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\nmsg += `*${L.total || 'TOTAL'}:* ${fmtCur(total)}\\n\\n`;\n\n// Quality legend\nconst qHigh = works.filter(w => w.ql === 'high').length;\nconst qMed = works.filter(w => w.ql === 'medium').length;\nconst qLow = works.filter(w => w.ql === 'low').length;\nconst qNone = works.filter(w => w.ql === 'not_found').length;\n\nmsg += `â— ${qHigh}  â—‹ ${qMed}  â—Œ ${qLow}  âœ• ${qNone}  (${d.pct}% ${L.found_pct || 'found'})\\n\\n`;\n\n// Cost breakdown\nif (d.workers_sum > 0 || d.materials_sum > 0 || d.machines_sum > 0) {\n  const parts = [];\n  if (d.workers_sum > 0) parts.push(`${L.workers || 'Labor'}: ${fmtCur(d.workers_sum)}`);\n  if (d.materials_sum > 0) parts.push(`${L.materials || 'Mat'}: ${fmtCur(d.materials_sum)}`);\n  if (d.machines_sum > 0) parts.push(`${L.machines || 'Equip'}: ${fmtCur(d.machines_sum)}`);\n  msg += parts.join(' Â· ') + '\\n';\n}\n\nif (d.labor_hours_sum > 0) {\n  const days = Math.ceil(d.labor_hours_sum / 8);\n  msg += `${L.labor_hours || 'Hours'}: ${fmt(d.labor_hours_sum)}h Â· ~${days} ${L.days || 'days'}\\n`;\n}\n\nmsg += `\\n_${L.price_note || 'Prices are approximate'}_\\n`;\nmsg += `_${L.more_in_html || 'Detailed report available'}_\\n\\n`;\nmsg += `*${L.what_next || 'Options'}:*`;\n\nreturn { json: { ...d, msg } };"
      },
      "id": "82cdf4df-0d6c-44df-ad0b-b146c7d5d33d",
      "name": "Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3088,
        1216
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "efcd9042-907c-4dd6-bcee-8b726931097d",
      "name": "ğŸ“¤ Final",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3312,
        1216
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $input.first().json;\nconst html = d.html_content || '';\nconst L = d.L || {};\nconst now = new Date();\nconst ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 16);\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${ts}.html`;\n\nreturn { json: { chatId: d.chatId, bot_token: d.bot_token, filename }, binary: { html: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "c328a036-dab0-466f-8430-7efca855c744",
      "name": "Prep HTML File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3312,
        1344
      ]
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "html",
        "additionalFields": {
          "caption": "ğŸ“Š Professional HTML Report",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "251180df-97b8-40c2-93fc-05e96618e1f3",
      "name": "ğŸ“¤ Send HTML",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3536,
        1344
      ],
      "webhookId": "40ef09ca-0039-405f-a274-b8b467888cb5",
      "credentials": {
        "telegramApi": {
          "id": "l5t1NiN0XgmAuJlO",
          "name": "OCE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Generate Excel file\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\n\n// Create CSV content (Excel-compatible)\nlet csv = '\\uFEFF'; // BOM for UTF-8\ncsv += `${L.doc_title || 'ESTIMATE'} - ${data.description || 'Photo Estimate'}\\n`;\ncsv += `${L.region || 'Region'} | ${new Date().toLocaleDateString()}\\n\\n`;\n\n// Headers\ncsv += `${L.col_pos || 'Pos'};${L.col_code || 'Code'};${L.col_desc || 'Description'};${L.col_unit || 'Unit'};${L.col_qty || 'Qty'};${L.col_price || 'Price'};${L.col_total || 'Total'}\\n`;\n\n// Data rows\nworks.forEach((w, i) => {\n  const name = (w.rate_name || w.name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n  csv += `${i+1};${w.rate_code || ''};\"${name}\";${w.rate_unit || w.unit || ''};${(w.qty || 0).toFixed(2)};${(w.uc || 0).toFixed(2)};${(w.tc || 0).toFixed(2)}\\n`;\n  \n  // Resources\n  (w.resources || []).forEach(r => {\n    const resName = (r.resource_name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n    csv += `;${r.resource_code || ''};\"  ${resName}\";${r.resource_unit || ''};${(r.scaled_quantity || 0).toFixed(3)};${(r.resource_price || 0).toFixed(2)};${(r.scaled_cost || 0).toFixed(2)}\\n`;\n  });\n});\n\n// Totals\ncsv += `\\n;;;;;${L.total || 'TOTAL'};${(data.total || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.workers || 'Labor'};${(data.workers_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.materials || 'Materials'};${(data.materials_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.machines || 'Equipment'};${(data.machines_sum || 0).toFixed(2)}\\n`;\n\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { excel: { data: Buffer.from(csv, 'utf-8').toString('base64'), mimeType: 'text/csv', fileName: filename } } };"
      },
      "id": "defae031-c154-430f-bfa3-36a0a6a5b3e4",
      "name": "Generate Excel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1488
      ]
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "excel",
        "additionalFields": {
          "caption": "={{ $json.L?.export_excel_msg || 'ğŸ“Š Excel Export (CSV)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "97326d9b-66e0-4577-bf74-d5df1dc795f7",
      "name": "ğŸ“¤ Send Excel",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1552,
        1488
      ],
      "webhookId": "59e74cff-1381-46c2-af45-3bd23b0e2241",
      "credentials": {
        "telegramApi": {
          "id": "l5t1NiN0XgmAuJlO",
          "name": "OCE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Generate PDF (using HTML-to-PDF service or return HTML)\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst html = sd.html_report || '';\nconst L = sd.lastResults?.L || cfg.L || {};\n\nif (!html) {\n  // No HTML report yet - send message\n  try {\n    await $http.request({\n      method: 'POST',\n      url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n      body: { chat_id: parseInt(cid), text: 'âŒ No report to export. Please calculate first.' },\n      json: true\n    });\n  } catch(e) {}\n  return { json: { skip: true } };\n}\n\n// For now, send HTML file as \"PDF alternative\"\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.html`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { pdf: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "e0e4fab7-6051-4cfa-8bfd-1270b03f3d7d",
      "name": "Generate PDF",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1632
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "344dddcb-deab-42bb-b992-ca6c5459c012",
      "name": "IF PDF",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1552,
        1632
      ]
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "pdf",
        "additionalFields": {
          "caption": "={{ $json.L?.export_pdf_msg || 'ğŸ“„ PDF Export (HTML)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "a5709506-29f4-44ea-9330-94703a31e94d",
      "name": "ğŸ“¤ Send PDF",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1776,
        1632
      ],
      "webhookId": "e96db3e9-92e0-408e-aa02-83634e0a67a3",
      "credentials": {
        "telegramApi": {
          "id": "l5t1NiN0XgmAuJlO",
          "name": "OCE"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR - Help*\\n\\n*What is DDC CWICR?*\\nOpen source construction cost database\\nhttps://DataDrivenConstruction.io\\n\\n*Features:*\\nğŸ“¸ Photo analysis with AI\\nğŸ“ Text input with work lists\\nğŸŒ 9 languages supported\\nğŸ“Š 55,000+ work items\\nğŸ’° Regional pricing (EUR, USD, RUB, etc.)\\nğŸ“„ Excel & PDF export\\n\\n*How to use:*\\n1. Select your language\\n2. Send photo OR text description\\n3. Edit detected works if needed\\n4. Get cost estimate\\n\\n*Commands:*\\n/start - New estimate\\n\\n*Contact:*\\nGitHub: github.com/ABoiko25/OpenConstructionEstimate\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [[{\"text\": \"â—€ï¸ Back\", \"callback_data\": \"back_to_lang\"}]]\n  }\n}",
        "options": {}
      },
      "id": "3d5a4523-f236-459a-b6a4-7d472aa90565",
      "name": "ğŸ“¤ Help",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        1776
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"Use /start to begin\"\n}",
        "options": {}
      },
      "id": "4826b5fb-2140-4801-83b8-5ccd206c0339",
      "name": "ğŸ“¤ Fallback",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        1904
      ]
    },
    {
      "parameters": {
        "content": "## ğŸ¤– Telegram Cost Estimation Bot v8.3 PRO\n**AI-powered construction cost estimation from photos**\n\nDataDrivenConstruction [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)\n\nâ­ **Star our repository** if you find this helpful!",
        "height": 144,
        "width": 616,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        128,
        256
      ],
      "id": "f3e88f28-ca80-440f-8f9c-82ea60cc98f1",
      "name": "Header"
    },
    {
      "parameters": {
        "content": "## âš™ï¸ Configuration\n\n**Required Credentials:**\n\n1. **Telegram Bot Token**\n   - Get from @BotFather\n   - Set in `ğŸ”‘ TOKEN` node\n\n2. **OpenAI API Key**\n   - For GPT-4o Vision & Whisper\n   - Connect to OpenAI nodes\n\n3. **Qdrant Vector DB**\n   - URL: Your Qdrant instance\n   - Collection: Language-specific\n\n**Language Collections:**\n```\nDE_BERLIN_workitems_...\nEN_TORONTO_workitems_...\nRU_STPETERSBURG_workitems_...\nES_BARCELONA_workitems_...\nFR_PARIS_workitems_...\nPT_SAOPAULO_workitems_...\nZH_SHANGHAI_workitems_...\nAR_DUBAI_workitems_...\nHI_MUMBAI_workitems_...\n```",
        "height": 520,
        "width": 340,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        128,
        448
      ],
      "id": "2b9b2205-a9c5-43e7-b6b9-98fa8017f924",
      "name": "Configuration"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Detailed view with resource prices\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\nconst sym = L.sym || 'â‚¬';\n\nfunction fmtCur(v) { \n  if (!v || v === 0) return sym + ' 0';\n  return sym + ' ' + v.toFixed(2); \n}\n\nlet msg = `*${L.ready} â€” ${L.resources}*\\n\\n`;\n\nworks.forEach((w, i) => {\n  const qi = { 'high': 'â—', 'medium': 'â—‹', 'low': 'â—Œ', 'not_found': 'âœ•' }[w.ql] || 'â—‹';\n  \n  msg += `*${i+1}. ${w.name}*\\n`;\n  if (w.rate_code && w.rate_code !== 'NOT_FOUND') {\n    msg += `${qi} \\`${w.rate_code}\\`\\n`;\n    if (w.rate_name && w.rate_name !== w.name) {\n      const rateName = (w.rate_name || '').substring(0, 45);\n      msg += `_${rateName}_\\n`;\n    }\n  } else {\n    msg += `${qi} _${L.not_found}_\\n`;\n  }\n  msg += `${w.qty} ${w.unit} Ã— ${fmtCur(w.uc)} = *${fmtCur(w.tc)}*\\n`;\n  \n  // Cost breakdown\n  const parts = [];\n  if (w.workers_total > 0) parts.push(`${L.workers}: ${fmtCur(w.workers_total)}`);\n  if (w.materials_total > 0) parts.push(`${L.materials}: ${fmtCur(w.materials_total)}`);\n  if (w.machines_total > 0) parts.push(`${L.machines}: ${fmtCur(w.machines_total)}`);\n  if (parts.length > 0) msg += `_${parts.join(' Â· ')}_\\n`;\n  \n  // Resources with prices\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    msg += `\\n`;\n    const showCount = Math.min(5, resources.length);\n    resources.slice(0, showCount).forEach((r, ri) => {\n      const isLast = ri === showCount - 1 && resources.length <= 5;\n      const prefix = isLast ? 'â””' : 'â”œ';\n      const typeTag = r.resource_type === 'labor' ? L.res_labor : r.resource_type === 'machine' ? L.res_machine : L.res_material;\n      const resName = (r.resource_name || '').substring(0, 26);\n      msg += `${prefix} *${typeTag}*: ${resName}\\n`;\n      \n      // Show quantity and cost\n      const qtyVal = r.scaled_quantity || r.resource_quantity || 0;\n      const costVal = r.scaled_cost || r.resource_cost || 0;\n      if (costVal > 0) {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''} = ${fmtCur(costVal)}\\n`;\n      } else {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''}\\n`;\n      }\n    });\n    if (resources.length > 5) {\n      msg += `â”” _...+${resources.length - 5} ${L.resources}_\\n`;\n    }\n  }\n  msg += `\\n`;\n});\n\n// Summary\nmsg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n`;\nconst totalParts = [];\nif (data.workers_sum > 0) totalParts.push(`${L.workers}: ${fmtCur(data.workers_sum)}`);\nif (data.materials_sum > 0) totalParts.push(`${L.materials}: ${fmtCur(data.materials_sum)}`);\nif (data.machines_sum > 0) totalParts.push(`${L.machines}: ${fmtCur(data.machines_sum)}`);\nif (totalParts.length > 0) msg += totalParts.join('\\n') + '\\n\\n';\n\nmsg += `*${L.total}: ${fmtCur(data.total || 0)}*\\n`;\n\nreturn { json: { ...cfg, msg, chatId: cid, bot_token: cfg.bot_token, L } };"
      },
      "id": "7334941f-db3c-4eac-a837-da7a75e49319",
      "name": "View Details",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1776
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').item.json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $json.L.btn_export_excel || 'â†“ Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'â†“ PDF' }}\", \"callback_data\": \"export_pdf\"}],\n      [{\"text\": \"{{ $json.L.btn_restart || 'â†» Restart' }}\", \"callback_data\": \"restart\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "c95d95d6-656d-4fbf-b3ab-198cae9283bd",
      "name": "ğŸ“¤ Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1552,
        1776
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Refine analysis with advanced prompt\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L;\n\n// Send message\ntry {\n  await $http.request({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n    body: { chat_id: parseInt(cid), text: `ğŸ”¬ ${L.analyzing || 'Analyzing...'}`, parse_mode: 'Markdown' },\n    json: true\n  });\n} catch(e) {}\n\n// Set flag for advanced analysis\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].use_advanced_prompt = true;\n\nreturn { json: { ...cfg, use_advanced_prompt: true } };"
      },
      "id": "0f140c21-1edc-4d18-b976-e7273440efe0",
      "name": "Refine Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1888
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Parse text input - extract work items from description\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || {};\n\n// Get text from various sources\nconst textInput = cfg.text || session.textInput || cfg.textInput || cfg.description || '';\n\nconsole.log('Text Analyze - input:', textInput);\n\nif (!textInput || textInput.length < 3) {\n  console.log('No text input!');\n  return { json: { ...cfg, chatId: cid, works: [], description: 'No input' }};\n}\n\n// Parse text locally (no API needed)\n// Pattern: \"Work name QTY UNIT\" per line\nconst lines = textInput.split('\\n').filter(l => l.trim());\nconst items = [];\n\nconst unitPatterns = [\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*(m2|Ğ¼2|mÂ²|Ğ¼Â²|ĞºĞ²\\.?\\s*Ğ¼)/i, unit: 'mÂ²' },\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*(m|Ğ¼|Ğ¿Ğ¼|lm)/i, unit: 'm' },\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*(ÑˆÑ‚|st|stk|stÃ¼ck|pcs|pc|ĞµĞ´)/i, unit: 'pcs' },\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*(kg|ĞºĞ³)/i, unit: 'kg' },\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*(l|Ğ»|ltr)/i, unit: 'l' },\n  { pattern: /(\\d+(?:[.,]\\d+)?)\\s*$/i, unit: 'pcs' }, // number at end without unit\n];\n\nfor (const line of lines) {\n  const trimmed = line.trim();\n  if (!trimmed || trimmed.length < 3) continue;\n  \n  let qty = 1;\n  let unit = 'mÂ²';\n  let name = trimmed;\n  \n  // Try to extract quantity and unit\n  for (const up of unitPatterns) {\n    const match = trimmed.match(up.pattern);\n    if (match) {\n      qty = parseFloat(match[1].replace(',', '.'));\n      unit = up.unit;\n      // Remove matched part from name\n      name = trimmed.replace(match[0], '').trim();\n      break;\n    }\n  }\n  \n  // Clean up name\n  name = name.replace(/^[-â€¢*]\\s*/, '').trim();\n  if (name.length < 2) name = trimmed.split(/\\d/)[0].trim();\n  \n  if (name.length >= 2) {\n    items.push({\n      name: name.substring(0, 60),\n      qty: qty || 1,\n      unit: unit,\n      conf: qty > 0 ? 'high' : 'medium'\n    });\n  }\n}\n\nconsole.log('Parsed items:', JSON.stringify(items));\n\n// Store in session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: cfg.lang };\nsd.sess[cid].works = items;\nsd.sess[cid].description = textInput.substring(0, 50) + (textInput.length > 50 ? '...' : '');\nsd.sess[cid].state = 'wait_edit';\n\nreturn { json: { \n  ...cfg, \n  chatId: cid, \n  works: items,\n  description: sd.sess[cid].description,\n  textInput\n}};"
      },
      "id": "6e767710-3cb7-4f60-8ec8-56b2f53bd2a3",
      "name": "Text Analyze",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        1984
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Prepare request for Vision API (Gemini or OpenAI GPT-4o)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $('Convert To Base64').first().json;\nconst photos = input.photos || [];\nconsole.log('=== PREP VISION ===');\nconsole.log('Photos received:', photos.length);\nconsole.log('Photo base64 lengths:', photos.map(p => p.base64?.length || 0));\nconst description = input.description || '';\nconst L = input.L || {};\nconst searchLang = L.search_lang || 'German';\n\n// Get config from TOKEN node\nconst tokenConfig = $('ğŸ”‘ TOKEN').first().json;\nconst provider = (tokenConfig.AI_PROVIDER || 'gemini').toLowerCase();\nconst geminiKey = tokenConfig.GEMINI_API_KEY;\nconst openaiKey = tokenConfig.OPENAI_API_KEY;\n\nconsole.log('AI Provider:', provider);\nconsole.log('Gemini Key length:', geminiKey ? geminiKey.length : 0);\nconsole.log('Gemini Key starts with:', geminiKey ? geminiKey.substring(0, 10) + '...' : 'EMPTY');\nconsole.log('OpenAI Key length:', openaiKey ? openaiKey.length : 0);\n\n// Check API key\nif (provider === 'gemini' && (!geminiKey || geminiKey === 'YOUR_GEMINI_API_KEY_HERE')) {\n  console.log('API URL:', apiUrl ? apiUrl.substring(0, 100) + '...' : 'EMPTY');\nconsole.log('Request body keys:', Object.keys(requestBody));\n\nconsole.log('Photos in request:', photos.length);\nreturn { json: {\n  _photo_count: photos.length,\n  _photo_sizes: photos.map(p => p.base64?.length || 0), ...input, error: 'GEMINI_API_KEY not configured', candidates: [] } };\n}\nif (provider === 'openai' && (!openaiKey || openaiKey === 'YOUR_OPENAI_API_KEY_HERE')) {\n  console.log('API URL:', apiUrl ? apiUrl.substring(0, 100) + '...' : 'EMPTY');\nconsole.log('Request body keys:', Object.keys(requestBody));\n\nconsole.log('Photos in request:', photos.length);\nreturn { json: {\n  _photo_count: photos.length,\n  _photo_sizes: photos.map(p => p.base64?.length || 0), ...input, error: 'OPENAI_API_KEY not configured', choices: [] } };\n}\n\n// Professional construction estimator prompt\nconst prompt = `Analyze these construction photos. Identify ONLY what you can ACTUALLY SEE.\n\nRULES:\n- List ONLY visible construction work, materials, or elements\n- Do NOT invent or assume anything not shown in the photos\n- Be specific to what is in THIS photo\n- Use professional terminology in ${searchLang}\n\n${description ? 'Context: ' + description : ''}\n\nFor each visible item provide:\n- name: Specific construction term in ${searchLang}\n- qty: Estimated quantity based on photo scale\n- unit: mÂ² / m / pcs / kg\n- conf: high (clearly visible) or medium (partially visible)\n- cat: demolition / rough / finishing / mep\n\nIMPORTANT: Do NOT use generic examples. Describe exactly what you see in the photo.\n\nRespond ONLY with JSON:\n{\"description\":\"What is shown\",\"items\":[{\"name\":\"specific work\",\"qty\":10,\"unit\":\"mÂ²\",\"conf\":\"high\",\"cat\":\"finishing\"}]}`;\n\nlet requestBody, apiUrl, apiKey;\n\nif (provider === 'openai') {\n  // OpenAI GPT-4o format\n  apiUrl = 'https://api.openai.com/v1/chat/completions';\n  apiKey = openaiKey;\n  \n  const content = [{ type: 'text', text: prompt }];\n  \n  // Add images\n  for (const photo of photos) {\n    if (photo.base64) {\n      content.push({\n        type: 'image_url',\n        image_url: {\n          url: 'data:image/jpeg;base64,' + photo.base64,\n          detail: 'high'\n        }\n      });\n    }\n  }\n  \n  requestBody = {\n    model: 'gpt-4o',\n    max_tokens: 4000,\n    temperature: 0.4,\n    messages: [\n      { role: 'system', content: 'You are an expert construction cost estimator. Respond only with valid JSON.' },\n      { role: 'user', content: content }\n    ]\n  };\n  \n} else {\n  // Gemini format (default)\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + geminiKey;\n  apiKey = geminiKey;\n  \n  const parts = [];\n  \n  // Add images first\n  for (const photo of photos) {\n    if (photo.base64) {\n      parts.push({\n        inline_data: {\n          mime_type: 'image/jpeg',\n          data: photo.base64\n        }\n      });\n    }\n  }\n  \n  // Add prompt\n  parts.push({ text: prompt });\n  \n  requestBody = {\n    contents: [{ parts: parts }],\n    generationConfig: {\n      temperature: 0.4,\n      maxOutputTokens: 4000\n    }\n  };\n}\n\nconsole.log('API URL:', apiUrl ? apiUrl.substring(0, 100) + '...' : 'EMPTY');\nconsole.log('Request body keys:', Object.keys(requestBody));\n\nconsole.log('Photos in request:', photos.length);\nreturn { json: {\n  _photo_count: photos.length,\n  _photo_sizes: photos.map(p => p.base64?.length || 0), \n  ...input, \n  provider: provider,\n  apiUrl: apiUrl,\n  apiKey: apiKey,\n  requestBody: requestBody \n}};"
      },
      "id": "8336f947-7930-4a7c-be07-e24ce30b7b32",
      "name": "Prep Vision",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        784
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.apiUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json.provider === 'openai' ? 'Bearer ' + $json.apiKey : '' }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.requestBody) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "a79cac5c-e0c3-4159-b7e6-8c52a9082559",
      "name": "Call Vision",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1856,
        896
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Merge Vision API response with original input data\n// Supports both Gemini and OpenAI responses\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Get original input (contains photos, L, chatId, provider, etc.)\nconst originalInput = $('Convert To Base64').first().json;\n\n// Get API response\nconst apiResponse = $input.first().json;\n\n// Merge: original data + API response\nreturn { \n  json: { \n    ...originalInput,\n    // Gemini response fields\n    candidates: apiResponse.candidates || [],\n    promptFeedback: apiResponse.promptFeedback,\n    // OpenAI response fields\n    choices: apiResponse.choices || [],\n    // Error handling\n    error: apiResponse.error\n  } \n};"
      },
      "id": "8d490251-4e01-432e-8096-004d77777881",
      "name": "Merge Vision",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2048,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Prepare photo download - pass file IDs to HTTP nodes\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst botToken = $('ğŸ”‘ TOKEN').first().json.bot_token;\nconst L = cfg.L || {};\n\n// Get photos from config (passed from Main)\nconst photos = cfg.photos || session.photos || [];\n\nconsole.log('Photos to download:', photos.length);\n\nif (!photos || photos.length === 0) {\n  return { json: { \n    ...cfg, \n    photos: [], \n    photoCount: 0,\n    skipDownload: true,\n    L\n  }};\n}\n\n// Take first photo for now (we'll loop for multiple later)\nconst firstPhoto = photos[0];\n\nreturn { json: { \n  ...cfg,\n  fileId: firstPhoto.fileId,\n  allPhotos: photos,\n  photoIndex: 0,\n  botToken: botToken,\n  L\n}};"
      },
      "id": "049f1aee-1127-44b7-87cb-958b7a153caf",
      "name": "Prep Photo Download",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        784
      ]
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $json.botToken }}/getFile?file_id={{ $json.fileId }}",
        "options": {}
      },
      "id": "9c5b896c-5e14-4413-9a83-4f60cb943840",
      "name": "Get File Path",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1888,
        784
      ]
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('Prep Photo Download').first().json.botToken }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "48a3b058-c326-472b-a5e8-72cd2f61e570",
      "name": "Download Photo File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2128,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Convert downloaded photo to base64 for Vision API\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst prepData = $('Prep Photo Download').first().json;\nconst binaryData = $input.first().binary;\n\nconsole.log('=== CONVERT TO BASE64 ===');\nconsole.log('Binary data keys:', Object.keys(binaryData || {}));\n\nconst photos = [];\n\nif (binaryData) {\n  // Get the first binary item\n  const binaryKey = Object.keys(binaryData)[0];\n  if (binaryKey && binaryData[binaryKey]) {\n    const item = binaryData[binaryKey];\n    console.log('Binary item keys:', Object.keys(item));\n    \n    // In n8n, binary data is stored as base64 in the 'data' property\n    if (item.data) {\n      photos.push({\n        base64: item.data,\n        caption: ''\n      });\n      console.log('SUCCESS: Base64 length:', item.data.length);\n    }\n  }\n}\n\n// TODO: Handle multiple photos (loop)\n// For now, we handle first photo only\n\nconst L = prepData.L || {};\n\nreturn { json: { \n  chatId: prepData.chatId,\n  bot_token: prepData.bot_token,\n  photos: photos,\n  photoCount: photos.length,\n  description: prepData.description || '',\n  L: L,\n  lang: prepData.lang\n}};"
      },
      "id": "ad746d9a-fb5d-462f-91b6-597b854e7545",
      "name": "Convert To Base64",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2384,
        784
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $(\"ğŸ”‘ TOKEN\").first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $(\"Config\").first().json.chatId }}, \"text\": \"ğŸ”„ {{ $(\"Config\").first().json.L.loading || 'Calculating...' }}\\n{{ $(\"Config\").first().json.L.searching || 'Searching rates in database' }}...\", \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "88848802-22eb-4a07-8b53-84e26e4c8ed4",
      "name": "ğŸ“¤ Send Progress",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1760,
        1344
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Save progress message ID for later deletion\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst telegramResponse = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Save message ID for deletion after calculation\nif (!sd.progress) sd.progress = {};\nsd.progress[cid] = {\n  message_id: telegramResponse.result?.message_id || 0,\n  chat_id: cfg.chatId\n};\n\nconsole.log('Progress message ID saved:', sd.progress[cid].message_id);\n\n// Return config for Prep Works\nreturn { json: cfg };"
      },
      "id": "0017b71e-f5c9-44db-8e43-6e797e8c346f",
      "name": "Save Progress ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        1344
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json.progress_message_id || 0 }}}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "7f85f3fd-bd0b-447d-a142-cc12dde085b2",
      "name": "ğŸ“¤ Delete Progress",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2848,
        1216
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Final').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $(\"Final\").first().json.chatId }}, \"text\": \"{{ $(\"Final\").first().json.L.what_next || 'Options:' }}\", \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"{{ $(\"Final\").first().json.L.resources || 'Resources' }}\", \"callback_data\": \"view_details\"}], [{\"text\": \"{{ $(\"Final\").first().json.L.btn_export_excel || 'Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $(\"Final\").first().json.L.btn_export_pdf || 'PDF' }}\", \"callback_data\": \"export_pdf\"}], [{\"text\": \"{{ $(\"Final\").first().json.L.btn_restart || 'New' }}\", \"callback_data\": \"restart\"}]]}}",
        "options": {}
      },
      "id": "8c41df2d-69c0-4bd3-bb78-063d5cadab92",
      "name": "ğŸ“¤ Send Keyboard",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3520,
        1216
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "ğŸ”‘ TOKEN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”‘ TOKEN": {
      "main": [
        [
          {
            "node": "Main",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Lang Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Lang CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Photo CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Analyze Options",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Analyze Options",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Photo Download",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Works Updated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Ask New Work",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Calc CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "View Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Refine Analysis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Text Analyze",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Lang CB": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Lang OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Photo CB": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Ask Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI": {
      "main": [
        [
          {
            "node": "Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Show Works": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Menu": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Edit Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Works Updated": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Works Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Calc CB": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Works": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop": {
      "main": [
        [
          {
            "node": "Agg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Qdrant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embed": {
      "ai_embedding": [
        [
          {
            "node": "Qdrant",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Qdrant": {
      "main": [
        [
          {
            "node": "Parse Q",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Q": {
      "main": [
        [
          {
            "node": "Acc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acc": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agg": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Delete Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prep HTML File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Final": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Keyboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep HTML File": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Excel": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate PDF": {
      "main": [
        [
          {
            "node": "IF PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF PDF": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "View Details": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refine Analysis": {
      "main": [
        [
          {
            "node": "Prep Photo Download",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text Analyze": {
      "main": [
        [
          {
            "node": "Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Vision": {
      "main": [
        [
          {
            "node": "Call Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Vision": {
      "main": [
        [
          {
            "node": "Merge Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Vision": {
      "main": [
        [
          {
            "node": "Parse AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Photo Download": {
      "main": [
        [
          {
            "node": "Get File Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get File Path": {
      "main": [
        [
          {
            "node": "Download Photo File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo File": {
      "main": [
        [
          {
            "node": "Convert To Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert To Base64": {
      "main": [
        [
          {
            "node": "Prep Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Send Progress": {
      "main": [
        [
          {
            "node": "Save Progress ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Progress ID": {
      "main": [
        [
          {
            "node": "Prep Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Delete Progress": {
      "main": [
        [
          {
            "node": "Generate HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "9015780e-01b1-4cfd-9318-f28a94cd7d0e",
  "meta": {
    "instanceId": "1d7b1da65c471e434188555a2959bd7f825cdfb684701b1bb9481fb29d0bd489"
  },
  "id": "i5GiA2xOki4AQRK7",
  "tags": []
}